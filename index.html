<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.5.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.5.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.5.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.5.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="不畏将来，不念过往">
<meta name="keywords" content="Java">
<meta property="og:type" content="website">
<meta property="og:title" content="以太格">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="以太格">
<meta property="og:description" content="不畏将来，不念过往">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="以太格">
<meta name="twitter:description" content="不畏将来，不念过往">






  <link rel="canonical" href="http://yoursite.com/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>以太格</title>
  











  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">以太格</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-commonweal">

    
    
    
      
    

    

    <a href="/404/" rel="section"><i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br>公益 404</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于我</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/11/21/rsocket-overview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Noahsark">
      <meta itemprop="description" content="不畏将来，不念过往">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以太格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2021/11/21/rsocket-overview/" class="post-title-link" itemprop="http://yoursite.com/index.html">RPC：RScocket</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2021-11-21 12:45:56" itemprop="dateCreated datePublished" datetime="2021-11-21T12:45:56+08:00">2021-11-21</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2021-11-27 18:14:23" itemprop="dateModified" datetime="2021-11-27T18:14:23+08:00">2021-11-27</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/RPC/" itemprop="url" rel="index"><span itemprop="name">RPC</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">71k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">1:05</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>RSocket 官网对 RSocket 定义：</p>
<blockquote>
<p>RSocket is a binary protocol for use on byte stream transports such as TCP, WebSockets, and Aeron.RSocket provides a protocol for Reactive Streams semantics between client-server, and server-server communication.</p>
</blockquote>
<p>RSocket 是一个构建在字节流传输协议，如 TCP, WebSocket 和 Aeron(UDP) 之上的二进制协议，同时，它也是一个为client-server,server-server 之间通信提供了反应式流语义的协议。本质上来说，RSocket 是基于反应式编程的一个二进制协议。一个反应式系统应该具备如下特征：</p>
<ul>
<li>Responsive: 只要有可能，系统就会及时地作出反应;</li>
<li>Resilient: 系统出现 failure 时仍然保持响应性，并能够独立恢复;</li>
<li>Elastic: 系统在不断变化的工作负载之下依然能保持即时响应性;</li>
<li>Message Driven: 异步非阻塞消息驱动架构。</li>
</ul>
<p>RSocket 作为一个应用层的协议，提供了丰富的功能：</p>
<ul>
<li>Multiplexed, Binary Protocol：多路复用的二进制协议；</li>
<li>Bidirectional Streaming: 双向流；</li>
<li>Flow Control: 流控制；</li>
<li>Socket Resumption: 连接恢复；</li>
<li>Message passing: 消息传递模型；</li>
<li>Transport independent: 与传输层解耦的应用层协议。</li>
</ul>
<p>在这篇文章，主要讲述与流相关的功能。</p>
<h2 id="Reactive-Streams"><a href="#Reactive-Streams" class="headerlink" title="Reactive Streams"></a>Reactive Streams</h2><h3 id="Flux-amp-Mono"><a href="#Flux-amp-Mono" class="headerlink" title="Flux &amp; Mono"></a>Flux &amp; Mono</h3><p>在 RSocket 中，使用 Flux 和 Mono 两个 Reactive Streams 框架来处理流数据，其中 Flux 处理一个流中 0 个或多个消息的场景，而 Mono 处理 0 个或最多 1 个消息的场景。</p>
<blockquote>
<p>Flux: A Reactive Streams Publisher with rx operators that emits 0 to N elements, and then completes (successfully or with an error).</p>
</blockquote>
<p><img src="/images/rpc/flux.svg" alt="flux" title="flux"></p>
<blockquote>
<p>Mono: A Reactive Streams Publisher with basic rx operators that emits at most one item via the onNext signal then terminates with an onComplete signal (successful Mono, with or without value), or only emits a single onError signal (failed Mono).</p>
</blockquote>
<p><img src="/images/rpc/mono.svg" alt="mono" title="mono"></p>
<p>Flux 和 Mono 都继承自 Publisher 接口，Publisher 接口只有一个方法 subscribe() 方法，这个方法主要是用来订阅 Subscriber 对象，而 Subscriber 对象用来消息处理数据。</p>
<p><img src="/images/rpc/rsocket-publisher-class.jpg" alt="rsocket-publisher-class" title="rsocket-publisher-class"></p>
<p>Publisher 使用了观察者模式，消费者订阅观察者对象 Subscriber，生产者通过 Publisher 对象发布数据，再通知给 Subscriber 对象。</p>
<p><img src="/images/rpc/rsocket-publisher.jpg" alt="rsocket-publiser" title="rsocket-publisher"></p>
<p>Subscriber 接口是消息最终处理接口，其定义如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Subscriber</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Invoked after calling &#123;<span class="doctag">@link</span> Publisher#subscribe(Subscriber)&#125;.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> s Subscription</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription s)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通知或接收数据</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t the element signaled</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Failed terminal state.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t the throwable signaled</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Successful terminal state.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Subscriber 接口的定义和功能与 gRPC 中 StreamObserver 是类似的。</p>
<h3 id="Frame-格式"><a href="#Frame-格式" class="headerlink" title="Frame 格式"></a>Frame 格式</h3><p>RSocket 使用二进制帧进行通信，其格式如下所示：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">0</span>                   <span class="number">1</span>                   <span class="number">2</span>                   <span class="number">3</span></span><br><span class="line"> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|<span class="number">0</span>|                         Stream ID                           |</span><br><span class="line">+-----------+-+-+---------------+-------------------------------+</span><br><span class="line">|Frame Type |I|M|     Flags     |</span><br><span class="line">+-------------------------------+-------------------------------+</span><br><span class="line">|              Metadata Length                  |</span><br><span class="line">+---------------------------------------------------------------+</span><br><span class="line">|                       Metadata Payload                       ...</span><br><span class="line">+---------------------------------------------------------------+</span><br><span class="line">|                       Payload of Frame                       ...</span><br><span class="line">+---------------------------------------------------------------+</span><br></pre></td></tr></table></figure></p>
<p><strong>字段描述：</strong></p>
<ul>
<li>Stream ID: (31 bits = max value 2^31-1 = 2,147,483,647), 用 31 位无符号整数表示 StreamId, 0 专门用来描述整个连接；</li>
<li>Frame Type:(6 bits = max value 63) 帧类型，下文会介绍；</li>
<li>Flags: (10 bits), 标志位，具体值取决于帧类型，0 表示不设置。协议要求，所有帧要带两个标志位: (I)gnore: 如果不识别该帧是否忽略 ,(M)etadata: 是否带有 Metadata; </li>
<li>Metadata Length: (24 bits = max value 16,777,215), 24 位无符号整数表示 Metadata 长度, 该部分可选，取决于是否有 Metadata; </li>
<li>Metadata: Metadata 元数据; </li>
<li>Payload: 数据。</li>
</ul>
<p><strong>帧类型：</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>RESERVED</td>
<td>0x00</td>
<td>Reserved</td>
</tr>
<tr>
<td><font color="red">SETUP</font></td>
<td>0x01</td>
<td>Setup: Sent by client to initiate protocol processing.</td>
</tr>
<tr>
<td>LEASE</td>
<td>0x02</td>
<td>Lease: Sent by Responder to grant the ability to send requests.</td>
</tr>
<tr>
<td>KEEPALIVE</td>
<td>0x03</td>
<td>Keepalive: Connection keepalive.</td>
</tr>
<tr>
<td><font color="red">REQUEST_RESPONSE</font></td>
<td>0x04</td>
<td>Request Response: Request single response.</td>
</tr>
<tr>
<td><font color="red">REQUEST_FNF</font></td>
<td>0x05</td>
<td>Fire And Forget: A single one-way message.</td>
</tr>
<tr>
<td><font color="red">REQUEST_STREAM </font></td>
<td>0x06</td>
<td>Request Stream: Request a completable stream.</td>
</tr>
<tr>
<td><font color="red">REQUEST_CHANNEL</font></td>
<td>0x07</td>
<td>Request Channel: Request a completable stream in both directions.</td>
</tr>
<tr>
<td>REQUEST_N</td>
<td>0x08</td>
<td>Request N: Request N more items with Reactive Streams semantics.</td>
</tr>
<tr>
<td>CANCEL</td>
<td>0x09</td>
<td>Cancel Request: Cancel outstanding request.</td>
</tr>
<tr>
<td><font color="red">PAYLOAD</font></td>
<td>0x0A</td>
<td>Payload: Payload on a stream. For example, response to a request, or message on a channel.</td>
</tr>
<tr>
<td>ERROR</td>
<td>0x0B</td>
<td>Error: Error at connection or application level.</td>
</tr>
<tr>
<td>METADATA_PUSH</td>
<td>0x0C</td>
<td>Metadata: Asynchronous Metadata frame</td>
</tr>
<tr>
<td><font color="red">RESUME</font></td>
<td>0x0D</td>
<td>Resume: Replaces SETUP for Resuming Operation (optional)</td>
</tr>
<tr>
<td>RESUME_OK</td>
<td>0x0E</td>
<td>Resume OK : Sent in response to a RESUME if resuming operation possible (optional)</td>
</tr>
<tr>
<td>EXT</td>
<td>0x3F</td>
<td>Extension Header: Used To Extend more frame types as well as extensions.</td>
</tr>
</tbody>
</table>
<p>在建立好连接之后，发送的第一帧是 SETUP 或 RESUME，主要用于协商客户端与服务器相关的信息，其中 RESUME 用于连接的重建。SETUP 帧的格式如下所示：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">0</span>                   <span class="number">1</span>                   <span class="number">2</span>                   <span class="number">3</span></span><br><span class="line"> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                         Stream ID = <span class="number">0</span>                         |</span><br><span class="line">+-----------+-+-+-+-+-----------+-------------------------------+</span><br><span class="line">|Frame Type |<span class="number">0</span>|M|R|L|  Flags    |</span><br><span class="line">+-----------+-+-+-+-+-----------+-------------------------------+</span><br><span class="line">|         Major Version         |        Minor Version          |</span><br><span class="line">+-------------------------------+-------------------------------+</span><br><span class="line">|<span class="number">0</span>|                 Time Between KEEPALIVE Frames               |</span><br><span class="line">+---------------------------------------------------------------+</span><br><span class="line">|<span class="number">0</span>|                       Max Lifetime                          |</span><br><span class="line">+---------------------------------------------------------------+</span><br><span class="line">|         Token Length          | Resume Identification Token  ...</span><br><span class="line">+---------------+-----------------------------------------------+</span><br><span class="line">|  MIME Length  |   Metadata Encoding MIME Type                ...</span><br><span class="line">+---------------+-----------------------------------------------+</span><br><span class="line">|  MIME Length  |     Data Encoding MIME Type                  ...</span><br><span class="line">+---------------+-----------------------------------------------+</span><br><span class="line">                      Metadata &amp; Setup Payload</span><br></pre></td></tr></table></figure>
<p>协商的内容包括协议的版本、KEEPALIVE 间隔时间(单位:ms)、服务保活最大时长(单位:ms)、用于 Resume 的 token(恢复连接时进行比对)、Metadata 编码类型及 Data 编码类型。一旦协商成功，就可以发送后续的请求帧。</p>
<h3 id="通信模型"><a href="#通信模型" class="headerlink" title="通信模型"></a>通信模型</h3><p>在 RSocket 中支持四种通信模型，分别是：</p>
<ul>
<li>Fire-Forget: 只发送 Request，不用 Response;</li>
<li>Request-Response: 一个 Request，一个 Response;</li>
<li>Request-Stream: 一个 Request, 响应为 Stream;</li>
<li>Channel：双向流。</li>
</ul>
<p><img src="/images/rpc/rsocket-interaction-model.png" alt="rsocket-interaction-model" title="rsocket-interaction-model"></p>
<p>四种通信模型对应的帧请求分别为:REQUEST_FNF,REQUEST_RESPONSE,REQUEST_STREAM 及 REQUEST_CHANNEL, 响应结果使用 PAYLOAD 帧，PAYLOAD 用来传输数据。另外，响应结束的 COMPLETE 标志位在 PAYLOAD 帧中定义。 PAYLOAD 定义如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">0</span>                   <span class="number">1</span>                   <span class="number">2</span>                   <span class="number">3</span></span><br><span class="line"> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                           Stream ID                           |</span><br><span class="line">+-----------+-+-+-+-+-+---------+-------------------------------+</span><br><span class="line">|Frame Type |<span class="number">0</span>|M|F|C|N|  Flags  |</span><br><span class="line">+-------------------------------+-------------------------------+</span><br><span class="line">                     Metadata &amp; Data</span><br></pre></td></tr></table></figure></p>
<ul>
<li>Frame Type: (6 bits) 0x0A;</li>
<li>Flags: (10 bits):<ul>
<li>(M)etadata: 带有 Metadata 数据；</li>
<li>(F)ollows: 表示是否将数据分包(fragments),请求数据大于一个 Frame 长度时使用；</li>
<li>(C)omplete: 流结束标志位，如果设置，onComplete() 方法会被调用; </li>
<li>(N)ext: 传递数据，如果设置，onNext(Payload) 方法会被调用;</li>
</ul>
</li>
<li>Payload Data: 数据</li>
</ul>
<p>REQUEST_FNF, REQUEST_RESPONSE, REQUEST_STREAM 及 REQUEST_CHANNEL 定义比较类似，也相对简单，以 REQUEST_RESPONSE 为例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">0</span>                   <span class="number">1</span>                   <span class="number">2</span>                   <span class="number">3</span></span><br><span class="line"> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                           Stream ID                           |</span><br><span class="line">+-----------+-+-+-+-------------+-------------------------------+</span><br><span class="line">|Frame Type |<span class="number">0</span>|M|F|     Flags   |</span><br><span class="line">+-------------------------------+</span><br><span class="line">                     Metadata &amp; Request Data</span><br></pre></td></tr></table></figure>
<ul>
<li>Frame Type: (6 bits) 0x04;</li>
<li>Flags: (10 bits):<ul>
<li>(M)etadata: 带有 Metadata 数据；</li>
<li>(F)ollows: 表示是否将数据分包(fragments),请求数据大于一个 Frame 长度时使用；<br>Request Data: 请求的数据</li>
</ul>
</li>
</ul>
<p>说完帧的格式，我们来看下 Requester 和 Responder 之间的通信流程，以 Request-Response 为例，先作以下约定：</p>
<blockquote>
<p>“RQ -&gt; RS” refers to Requester sending a frame to a Responder. And “RS -&gt; RQ” refers to Responder.<br>“*” refers to 0 or more and “+” refers to 1 or more.</p>
</blockquote>
<p><strong>Request-Response:</strong><br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> RQ -&gt; RS: REQUEST_RESPONSE</span><br><span class="line"><span class="number">2.</span> RS -&gt; RQ: PAYLOAD with COMPLETE</span><br><span class="line">or</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> RQ -&gt; RS: REQUEST_RESPONSE</span><br><span class="line"><span class="number">2.</span> RS -&gt; RQ: ERROR[APPLICATION_ERROR|REJECTED|CANCELED|INVALID]</span><br><span class="line">or</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> RQ -&gt; RS: REQUEST_RESPONSE</span><br><span class="line"><span class="number">2.</span> RQ -&gt; RS: CANCEL</span><br></pre></td></tr></table></figure></p>
<p>有三种情况：</p>
<ol>
<li>请求正常，Requester 发送一个 REQUEST_RESPONSE 帧，Responder 响应一个带 COMPLETE 标志位的 PAYLOAD;</li>
<li>请求出错，Requester 发送一个 REQUEST_RESPONSE 帧，Responder 响应一个 ERROR 帧，帧中带有错误码及错误信息；</li>
<li>请求取消，Requester 发送一个 REQUEST_RESPONSE 帧，紧接着发送一个 CANCEL, 取消请求。</li>
</ol>
<p>对于 Stream 的情况，则会发送多个 PAYLOAD 帧。</p>
<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><h3 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.rsocket<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rsocket-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.rsocket<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rsocket-transport-netty<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>实例底层的传输使用的是 TCP, 框架采用的是 Netty.</p>
<h3 id="服务器端"><a href="#服务器端" class="headerlink" title="服务器端"></a>服务器端</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RSocket</span> <span class="keyword">extends</span> <span class="title">Availability</span>, <span class="title">Closeable</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="function">Mono&lt;Void&gt; <span class="title">fireAndForget</span><span class="params">(Payload payload)</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function">Mono&lt;Payload&gt; <span class="title">requestResponse</span><span class="params">(Payload payload)</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function">Flux&lt;Payload&gt; <span class="title">requestStream</span><span class="params">(Payload payload)</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function">Flux&lt;Payload&gt; <span class="title">requestChannel</span><span class="params">(Publisher&lt;Payload&gt; payloads)</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function">Mono&lt;Void&gt; <span class="title">metadataPush</span><span class="params">(Payload payload)</span></span>;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在服务端需要实现 RSocket 接口，并将其添加到服务器中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Server</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 初始化服务器，并向器添加服务实现 RSocketImpl</span></span><br><span class="line">    <span class="keyword">this</span>.server = RSocketFactory.receive()</span><br><span class="line">            .acceptor((setupPayload, reactiveSocket) -&gt; Mono.just(<span class="keyword">new</span> RSocketImpl()))</span><br><span class="line">            .transport(TcpServerTransport.create(<span class="string">"localhost"</span>, TCP_PORT))</span><br><span class="line">            .start()</span><br><span class="line">            .doOnNext(x -&gt; LOG.info(<span class="string">"Server started"</span>))</span><br><span class="line">            .subscribe();</span><br><span class="line"></span><br><span class="line">    initService();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>服务端的 RSocketImpl 代码逻辑如下所示：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * RSocket implementation</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">RSocketImpl</span> <span class="keyword">extends</span> <span class="title">AbstractRSocket</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle Request/Response messages</span></span><br><span class="line"><span class="comment">     * 将请求数据返回给客户端</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payload Message payload</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> payload response</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Payload&gt; <span class="title">requestResponse</span><span class="params">(Payload payload)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            LOG.info(<span class="string">"payload:&#123;&#125;"</span>, payload);</span><br><span class="line">            <span class="keyword">return</span> Mono.just(payload); <span class="comment">// reflect the payload back to the sender</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception x) &#123;</span><br><span class="line">            <span class="keyword">return</span> Mono.error(x);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle Fire-and-Forget messages</span></span><br><span class="line"><span class="comment">     * 将数据发布到 dataPublisher 中</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payload Message payload</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> nothing</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">fireAndForget</span><span class="params">(Payload payload)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            dataPublisher.publish(payload); <span class="comment">// forward the payload</span></span><br><span class="line">            <span class="keyword">return</span> Mono.empty();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception x) &#123;</span><br><span class="line">            <span class="keyword">return</span> Mono.error(x);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle Request/Stream messages. Each request returns a new stream.</span></span><br><span class="line"><span class="comment">     * 使用 dataPublisher 作为响应，数据来源自 fireAndForget 中的数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payload Payload that can be used to determine which stream to return</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Flux stream containing simulated measurement data</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Flux&lt;Payload&gt; <span class="title">requestStream</span><span class="params">(Payload payload)</span> </span>&#123;</span><br><span class="line">        String streamName = payload.getDataUtf8();</span><br><span class="line">        <span class="keyword">if</span> (DATA_STREAM_NAME.equals(streamName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Flux.from(dataPublisher);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Flux.error(<span class="keyword">new</span> IllegalArgumentException(streamName));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle request for bidirectional channel</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payloads Stream of payloads delivered from the client</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Flux&lt;Payload&gt; <span class="title">requestChannel</span><span class="params">(Publisher&lt;Payload&gt; payloads)</span> </span>&#123;</span><br><span class="line">        Flux.from(payloads)</span><br><span class="line">                .subscribe(gameController::processPayload);</span><br><span class="line">        Flux&lt;Payload&gt; channel = Flux.from(gameController);</span><br><span class="line">        <span class="keyword">return</span> channel;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Simple PUblisher to provide async data to Flux stream</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataPublisher</span> <span class="keyword">implements</span> <span class="title">Publisher</span>&lt;<span class="title">Payload</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Subscriber&lt;? <span class="keyword">super</span> Payload&gt;&gt; subscribers = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> Payload&gt; subscriber)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.subscribers.add(subscriber);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发布数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payload 数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publish</span><span class="params">(Payload payload)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        subscribers.stream().forEach(subscriber -&gt; subscriber.onNext(payload));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据结束</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">complete</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        subscribers.stream().forEach(subscriber -&gt; subscriber.onComplete());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="客户端代码"><a href="#客户端代码" class="headerlink" title="客户端代码"></a>客户端代码</h3><p><strong>Fire-and-Forget</strong><br>客户端定时 50s 发送一次数据到服务器，不用服务器响应。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 客户端 socket</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RSocket socket;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;Float&gt; data;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构建客户端</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FireNForgetClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.socket = RSocketFactory.connect()</span><br><span class="line">            .transport(TcpClientTransport.create(<span class="string">"localhost"</span>, TCP_PORT))</span><br><span class="line">            .start()</span><br><span class="line">            .block();</span><br><span class="line">    <span class="keyword">this</span>.data = Collections.unmodifiableList(generateData());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Send binary velocity (float) every 50ms</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Flux.interval(Duration.ofMillis(<span class="number">50</span>))</span><br><span class="line">            .take(data.size())</span><br><span class="line">            .map(<span class="keyword">this</span>::createFloatPayload)</span><br><span class="line">            .flatMap(socket::fireAndForget)</span><br><span class="line">            .blockLast();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>Request-Response</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送一个字符串到服务器，并同步等待结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string 参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">callBlocking</span><span class="params">(String string)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> socket</span><br><span class="line">            .requestResponse(DefaultPayload.create(string))</span><br><span class="line">            .map(Payload::getDataUtf8)</span><br><span class="line">            .onErrorReturn(ERROR_MSG)</span><br><span class="line">            .block();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>Request-Stream</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回一个 Float 列表，一个响应一个 Float</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Float 数字</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Flux&lt;Float&gt; <span class="title">getDataStream</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> socket</span><br><span class="line">            .requestStream(DefaultPayload.create(DATA_STREAM_NAME))</span><br><span class="line">            .map(Payload::getData)</span><br><span class="line">            .map(buf -&gt; buf.getFloat())</span><br><span class="line">            .onErrorReturn(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>Stream-Stream</strong><br>通过 GameController 类，既实现了数据在发送，也实现了数据的处理。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 客户端 socket</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RSocket socket;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送流及处理流</span></span><br><span class="line"><span class="comment"> * 发送流：fireAtWill 方法，线程定时发送数据</span></span><br><span class="line"><span class="comment"> * 接收流：processPayload 方法，处理响应数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> GameController gameController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构建客户端</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ChannelClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.socket = RSocketFactory.connect()</span><br><span class="line">            .transport(TcpClientTransport.create(<span class="string">"localhost"</span>, TCP_PORT))</span><br><span class="line">            .start()</span><br><span class="line">            .block();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.gameController = <span class="keyword">new</span> GameController(<span class="string">"Client Player"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 双向数据流</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">playGame</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    socket.requestChannel(Flux.from(gameController))</span><br><span class="line">            .doOnNext(gameController::processPayload)</span><br><span class="line">            .blockLast();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>GameController 处理逻辑如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GameController</span> <span class="keyword">implements</span> <span class="title">Publisher</span>&lt;<span class="title">Payload</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(GameController<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String playerName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Long&gt; shots;</span><br><span class="line">    <span class="keyword">private</span> Subscriber&lt;? <span class="keyword">super</span> Payload&gt; subscriber;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> truce = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GameController</span><span class="params">(String playerName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.playerName = playerName;</span><br><span class="line">        <span class="keyword">this</span>.shots = generateShotList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a random list of time intervals, 0-1000ms</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> List of time intervals</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;Long&gt; <span class="title">generateShotList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Flux.range(<span class="number">1</span>, SHOT_COUNT)</span><br><span class="line">                .map(x -&gt; (<span class="keyword">long</span>) Math.ceil(Math.random() * <span class="number">1000</span>))</span><br><span class="line">                .collectList()</span><br><span class="line">                .block();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> Payload&gt; subscriber)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.subscriber = subscriber;</span><br><span class="line">        fireAtWill();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Publish game events asynchronously</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fireAtWill</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (Long shotDelay : shots) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123; Thread.sleep(shotDelay); &#125; <span class="keyword">catch</span> (Exception x) &#123;&#125;</span><br><span class="line">                <span class="keyword">if</span> (truce) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                LOG.info(<span class="string">"&#123;&#125;: bang!"</span>, playerName);</span><br><span class="line">                subscriber.onNext(DefaultPayload.create(<span class="string">"bang!"</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!truce) &#123;</span><br><span class="line">                LOG.info(<span class="string">"&#123;&#125;: I give up!"</span>, playerName);</span><br><span class="line">                subscriber.onNext(DefaultPayload.create(<span class="string">"I give up"</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            subscriber.onComplete();</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Process events from the opponent</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payload Payload received from the rSocket</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processPayload</span><span class="params">(Payload payload)</span> </span>&#123;</span><br><span class="line">        String message = payload.getDataUtf8();</span><br><span class="line">        <span class="keyword">switch</span> (message) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"bang!"</span>:</span><br><span class="line">                String result = Math.random() &lt; <span class="number">0.5</span> ? <span class="string">"Haha missed!"</span> : <span class="string">"Ow!"</span>;</span><br><span class="line">                LOG.info(<span class="string">"&#123;&#125;: &#123;&#125;"</span>, playerName, result);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"I give up"</span>:</span><br><span class="line">                truce = <span class="keyword">true</span>;</span><br><span class="line">                LOG.info(<span class="string">"&#123;&#125;: OK, truce"</span>, playerName);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<font color="red">流的操作主要是通过 Publisher 类来实现的。</font>

<h3 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenSendingAString_thenRevceiveTheSameString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ReqResClient client = <span class="keyword">new</span> ReqResClient();</span><br><span class="line">    String string = <span class="string">"Hello RSocket"</span>;</span><br><span class="line"></span><br><span class="line">    assertEquals(string, client.callBlocking(string));</span><br><span class="line"></span><br><span class="line">    client.dispose();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenSendingFireForget</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    FireNForgetClient fnfClient = <span class="keyword">new</span> FireNForgetClient();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// start sending the data</span></span><br><span class="line">    List&lt;Float&gt; data = fnfClient.getData();</span><br><span class="line">    data.stream().forEach(System.out::println);</span><br><span class="line">    fnfClient.sendData();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">        ex.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1. 通过 FireNForgetClient 向服务器定时发送 Float 数据；</span></span><br><span class="line"><span class="comment"> * 2. 服务器接收数据，向 dataPublisher 发布数据；</span></span><br><span class="line"><span class="comment"> * 3. 通过 ReqStreamClient 向服务器请求流数据，数据来自 dataPublisher；</span></span><br><span class="line"><span class="comment"> * 4. ReqStreamClient 订阅来自服务器的数据并处理；</span></span><br><span class="line"><span class="comment"> * 5. 通过 dataPublisher 实现了将 FireNForgetClient 产生的数据发送给了 ReqStreamClient。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenSendingStream_thenReceiveTheSameStream</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// create the client that pushes data to the server and start sending</span></span><br><span class="line">    FireNForgetClient fnfClient = <span class="keyword">new</span> FireNForgetClient();</span><br><span class="line">    <span class="comment">// create a client to read a stream from the server and subscribe to events</span></span><br><span class="line">    ReqStreamClient streamClient = <span class="keyword">new</span> ReqStreamClient();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get the data that is used by the client</span></span><br><span class="line">    List&lt;Float&gt; data = fnfClient.getData();</span><br><span class="line">    <span class="comment">// create a place to count the results</span></span><br><span class="line">    List&lt;Float&gt; dataReceived = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// assert that the data received is the same as the data sent</span></span><br><span class="line">    Disposable subscription = streamClient.getDataStream()</span><br><span class="line">            .index()</span><br><span class="line">            .subscribe(</span><br><span class="line">                    tuple -&gt; &#123;</span><br><span class="line">                        assertEquals(<span class="string">"Wrong value"</span>, data.get(tuple.getT1().intValue()), tuple.getT2());</span><br><span class="line">                        LOG.info(<span class="string">"index:&#123;&#125;,data:&#123;&#125;"</span>,tuple.getT1(),tuple.getT2());</span><br><span class="line">                        dataReceived.add(tuple.getT2());</span><br><span class="line">                    &#125;,</span><br><span class="line">                    err -&gt; LOG.error(err.getMessage())</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// start sending the data</span></span><br><span class="line">    fnfClient.sendData();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// wait a short time for the data to complete then dispose everything</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception x) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    subscription.dispose();</span><br><span class="line">    fnfClient.dispose();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// verify the item count</span></span><br><span class="line">    assertEquals(<span class="string">"Wrong data count received"</span>, data.size(), dataReceived.size());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenRunningChannelGame_thenLogTheResults</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ChannelClient client = <span class="keyword">new</span> ChannelClient();</span><br><span class="line">    client.playGame();</span><br><span class="line">    client.dispose();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过分析 RSocket 通信协议，我们理解了 RSocket 四种通信模型的基本原理，不过 RSocket 提供的功能不仅限于这些，它还提供了更多高级的功能，如文章开头介绍的那样。RSocket 官网提供了翔实的文档，如果感兴趣的话，可以深入理解下。</p>
<p><strong>参考：</strong></p>
<hr>
<p><a href="https://rsocket.io/" target="_blank" rel="noopener">1. rsocket 官方文档</a><br><a href="https://zhuanlan.zhihu.com/p/100511637" target="_blank" rel="noopener">2. RSocket 基于消息传递的反应式应用层网络协议</a><br><a href="https://www.reactivemanifesto.org/zh-CN" target="_blank" rel="noopener">3. 反应式宣言</a><br><a href="https://www.baeldung.com/rsocket" target="_blank" rel="noopener">4. Introduction to RSocket</a><br><a href="https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Flux.html" target="_blank" rel="noopener">5. Flux API</a><br><a href="https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Mono.html" target="_blank" rel="noopener">6. Mono API</a><br><a href="https://medium.com/@b3rnoulli/reactive-service-to-service-communication-with-rsocket-introduction-5d64e5b6909" target="_blank" rel="noopener">7. Reactive service to service communication with RSocket — Introduction</a><br><a href="https://rsocket.io/about/protocol/" target="_blank" rel="noopener">8. Rsocket protocol</a><br><a href="https://javakk.com/1820.html" target="_blank" rel="noopener">9. 响应式服务通信协议RSocket</a></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/11/21/dubbo-overview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Noahsark">
      <meta itemprop="description" content="不畏将来，不念过往">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以太格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2021/11/21/dubbo-overview/" class="post-title-link" itemprop="http://yoursite.com/index.html">RPC：Dubbo</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2021-11-21 10:14:06" itemprop="dateCreated datePublished" datetime="2021-11-21T10:14:06+08:00">2021-11-21</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2021-11-27 18:16:40" itemprop="dateModified" datetime="2021-11-27T18:16:40+08:00">2021-11-27</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/RPC/" itemprop="url" rel="index"><span itemprop="name">RPC</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">53k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">48 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Dubbo 官网对 Dubbo 的描述：</p>
<blockquote>
<p>Apache Dubbo 是一款微服务开发框架，它提供了 RPC通信 与 微服务治理 两大关键能力。这意味着，使用 Dubbo 开发的微服务，将具备相互之间的远程发现与通信能力， 同时利用 Dubbo 提供的丰富服务治理能力，可以实现诸如服务发现、负载均衡、流量调度等服务治理诉求。同时 Dubbo 是高度可扩展的，用户几乎可以在任意功能点去定制自己的实现，以改变框架的默认行为来满足自己的业务需求。</p>
</blockquote>
<p>Dubbo 目前有两个大的版本：2.x 和 3.0，2.x 版本也是我们在项目中使用的版本，这是一个同步的 Request-Response 模型的 RPC 框架，而 3.0 版本通过引入 triple 协议，支持了更多的通信模型：</p>
<ul>
<li>消费端异步请求(Client Side Asynchronous Request-Response)</li>
<li>提供端异步执行（Server Side Asynchronous Request-Response）</li>
<li>消费端请求流（Request Streaming）</li>
<li>提供端响应流（Response Streaming）</li>
<li>双向流式通信（Bidirectional Streaming）</li>
</ul>
<p>Dubbo 官网将 triple 定义为下一代 RPC 通信协议，是这样描述的：</p>
<blockquote>
<p>定义了全新的 RPC 通信协议 – Triple，一句话概括 Triple：它是基于 HTTP/2 上构建的 RPC 协议，完全兼容 gRPC，并在此基础上扩展出了更丰富的语义。 使用 Triple 协议，用户将获得以下能力:</p>
<ul>
<li>更容易到适配网关、Mesh架构，Triple 协议让 Dubbo 更方便的与各种网关、Sidecar 组件配合工作。</li>
<li>多语言友好，推荐配合 Protobuf 使用 Triple 协议，使用 IDL 定义服务，使用 Protobuf 编码业务数据。</li>
<li>流式通信支持。Triple 协议支持 Request Stream、Response Stream、Bi-direction Stream。</li>
</ul>
</blockquote>
<p>从同步/异步和通信模型两个维度来总结：</p>
<ul>
<li>Dubbo 2.x 是一个同步的、只支持 Request-Response 模型的 RPC 框架；</li>
<li>Dubbo 3.0 支持异步、支持 Request Stream、Response Stream、Bi-direction Stream 多种通信模型的下一代 RPC 通信框架。</li>
</ul>
<p>后面以一个 Java 实例来演示下它的功能。</p>
<h2 id="Dubbo-服务模型"><a href="#Dubbo-服务模型" class="headerlink" title="Dubbo 服务模型"></a>Dubbo 服务模型</h2><h3 id="一个简化模型"><a href="#一个简化模型" class="headerlink" title="一个简化模型"></a>一个简化模型</h3><p>在 Dubbo 服务模型中有几个重要的概念：</p>
<ul>
<li>Invoker：它是 Dubbo 的核心模型，其它模型都向它靠扰，或转换成它，它代表一个可执行体，可以向它发起调用，它有可能是一个本地的实现，也可能是一个远程的实现，也可能一个集群实现；在客户端，它作为服务的调用方，向服务端发起调用，在服务端，它封装了服务实现类，代表了最终的服务提供方；</li>
<li>Exporter：它封装了服务端的 Invoker 对象，将服务发布出去；</li>
<li>Protocol: 它负责 Exporter 和 Invoker 对象的生命周期管理；</li>
<li>Invocation：它持有调用过程中的变量，比如方法名，参数等。</li>
</ul>
<p>一个简化的模型如下图所示：<br><img src="/images/rpc/dubbo-model.png" alt="dubbo-model" title="dubbo-model"></p>
<h3 id="发布服务"><a href="#发布服务" class="headerlink" title="发布服务"></a>发布服务</h3><p>在服务端，将服务实现封装成为一个 Invoker 对象，通过 Exporter 发布出去。<br><img src="/images/rpc/dubbo-deploy-servie.png" alt="dubbo-deploy-servie" title="dubbo-deploy-servie"></p>
<h3 id="引用服务"><a href="#引用服务" class="headerlink" title="引用服务"></a>引用服务</h3><p>在客户端，将一次远程 RPC 调用转化为本地 Invoker 对象的调用，再通过 Invoker 对象发起远程的调用。<br><img src="/images/rpc/dubbo-refer-servie.png" alt="dubbo-refer-servie" title="dubbo-refer-servie"></p>
<h2 id="Java-Dubbo-实例"><a href="#Java-Dubbo-实例" class="headerlink" title="Java Dubbo 实例"></a>Java Dubbo 实例</h2><h3 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h3><p>Triple 协议依赖 Protocol Buffers 及 gRPC, Protocol Buffers 用来作为数据的序列化及服务的定义，在 Java 实例里没有使用 Protocol Buffers 来进行服务定义，如果是其它语言，官方建议使用  Protocol Buffers 作为 IDL 来描述服务，从而获得跨平台的能力。另外，Dubbo 扩展了 grpc-java 代码生成插件，从这点来看，Dubbo Triple 协议是否也可以理解为 gRPC 协议的扩展？</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.9<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.9<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">source.level</span>&gt;</span>1.9<span class="tag">&lt;/<span class="name">source.level</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">target.level</span>&gt;</span>1.9<span class="tag">&lt;/<span class="name">target.level</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo.version</span>&gt;</span>3.0.4<span class="tag">&lt;/<span class="name">dubbo.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">grpc.version</span>&gt;</span>1.40.1<span class="tag">&lt;/<span class="name">grpc.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven-compiler-plugin.version</span>&gt;</span>3.7.0<span class="tag">&lt;/<span class="name">maven-compiler-plugin.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven-failsafe-plugin.version</span>&gt;</span>2.21.0<span class="tag">&lt;/<span class="name">maven-failsafe-plugin.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">protoc.version</span>&gt;</span>3.7.1<span class="tag">&lt;/<span class="name">protoc.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo.compiler.version</span>&gt;</span>0.0.4-SNAPSHOT<span class="tag">&lt;/<span class="name">dubbo.compiler.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;dubbo.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.protobuf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protobuf-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.14.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-dependencies-zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;dubbo.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;grpc.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.testcontainers<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>testcontainers<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.12.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">extensions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">extension</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>kr.motd.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>os-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">extension</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">extensions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.xolstice.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protobuf-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">protocArtifact</span>&gt;</span>com.google.protobuf:protoc:$&#123;protoc.version&#125;:exe:$&#123;os.detected.classifier&#125;<span class="tag">&lt;/<span class="name">protocArtifact</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">pluginId</span>&gt;</span>grpc-java<span class="tag">&lt;/<span class="name">pluginId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">pluginArtifact</span>&gt;</span>io.grpc:protoc-gen-grpc-java:$&#123;grpc.version&#125;:exe:$&#123;os.detected.classifier&#125;<span class="tag">&lt;/<span class="name">pluginArtifact</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">protocPlugins</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">protocPlugin</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-compiler<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;dubbo.compiler.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>org.apache.dubbo.gen.dubbo.Dubbo3Generator<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">protocPlugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">protocPlugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>test-compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile-custom<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>test-compile-custom<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;maven-compiler-plugin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>$&#123;source.level&#125;<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>$&#123;target.level&#125;<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a>接口定义</h3><p>接口定义分为两个部分，一个是接口描述，另外一个是请求及响应参数描述。在这里，接口使用 Java 语言描述，而参数使用 Protocol Buffers 来描述。</p>
<p><strong>接口描述</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IGreeter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Request-Response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request 请求</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 响应</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">HelloReply <span class="title">sayHello</span><span class="params">(HelloRequest request)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * stream-stream</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> replyStream response stream </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> request stream</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">StreamObserver&lt;HelloRequest&gt; <span class="title">bidiHello</span><span class="params">(StreamObserver&lt;HelloReply&gt; replyStream)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * request-stream</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request 请求</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> replyStream 响应</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">lotsOfReplies</span><span class="params">(HelloRequest request, StreamObserver&lt;HelloReply&gt; replyStream)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * stream-response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> replyStream response stream</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> request stream</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">StreamObserver&lt;HelloRequest&gt; <span class="title">lotsOfGreetings</span><span class="params">(StreamObserver&lt;HelloReply&gt; replyStream)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>参数描述</strong><br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"></span><br><span class="line">option java_multiple_files = <span class="literal">true</span>;</span><br><span class="line">option java_package = <span class="string">"org.apache.dubbo.hello"</span>;</span><br><span class="line">option java_outer_classname = <span class="string">"HelloWorldProto"</span>;</span><br><span class="line">option objc_class_prefix = <span class="string">"HLW"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> helloworld;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The request message containing the user's name.</span></span><br><span class="line">message HelloRequest &#123;</span><br><span class="line">  <span class="keyword">string</span> name = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The response message containing the greetings</span></span><br><span class="line">message HelloReply &#123;</span><br><span class="line">  <span class="keyword">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>执行 mvn package 生成代码。</p>
<h3 id="客户端代码"><a href="#客户端代码" class="headerlink" title="客户端代码"></a>客户端代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义服务消费</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ApiConsumer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IGreeter delegate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义服务消费方</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ApiConsumer() &#123;</span><br><span class="line">        <span class="comment">// 定义一个服务引用</span></span><br><span class="line">        ReferenceConfig&lt;IGreeter&gt; ref = <span class="keyword">new</span> ReferenceConfig&lt;&gt;();</span><br><span class="line">        ref.setInterface(IGreeter<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        ref.setCheck(<span class="keyword">false</span>);</span><br><span class="line">        ref.setInterface(IGreeter<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        ref.setCheck(<span class="keyword">false</span>);</span><br><span class="line">        ref.setProtocol(CommonConstants.TRIPLE);</span><br><span class="line">        ref.setLazy(<span class="keyword">true</span>);</span><br><span class="line">        ref.setTimeout(<span class="number">100000</span>);</span><br><span class="line"></span><br><span class="line">        ApplicationConfig applicationConfig = <span class="keyword">new</span> ApplicationConfig(<span class="string">"demo-consumer"</span>);</span><br><span class="line">        applicationConfig.setQosPort(<span class="number">33333</span>);</span><br><span class="line"></span><br><span class="line">        DubboBootstrap bootstrap = DubboBootstrap.getInstance();</span><br><span class="line">        bootstrap.application(applicationConfig)</span><br><span class="line">                .registry(<span class="keyword">new</span> RegistryConfig(TriSampleConstants.ZK_ADDRESS))</span><br><span class="line">                .reference(ref)</span><br><span class="line">                .start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成代理对象</span></span><br><span class="line">        <span class="keyword">this</span>.delegate = ref.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * request-stream</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lotsOfReplies</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        delegate.lotsOfReplies(HelloRequest.newBuilder()</span><br><span class="line">                .setName(<span class="string">"allen"</span>)</span><br><span class="line">                .build(), <span class="keyword">new</span> StdoutStreamObserver&lt;&gt;(<span class="string">"serverStream"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * stream-response</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lotsOfGreetings</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> StreamObserver&lt;HelloRequest&gt; request = delegate.lotsOfGreetings(<span class="keyword">new</span> StdoutStreamObserver&lt;&gt;(<span class="string">"lotsOfGreetings"</span>));</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            request.onNext(HelloRequest.newBuilder()</span><br><span class="line">                    .setName(<span class="string">"allen"</span>)</span><br><span class="line">                    .build());</span><br><span class="line">        &#125;</span><br><span class="line">        request.onCompleted();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * stream-stream</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bidiHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> StreamObserver&lt;HelloRequest&gt; request = delegate.bidiHello(<span class="keyword">new</span> StdoutStreamObserver&lt;&gt;(<span class="string">"stream"</span>));</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            request.onNext(HelloRequest.newBuilder()</span><br><span class="line">                    .setName(<span class="string">"allen"</span>)</span><br><span class="line">                    .build());</span><br><span class="line">        &#125;</span><br><span class="line">        request.onCompleted();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * request-response</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> HelloReply reply = delegate.sayHello(HelloRequest.newBuilder()</span><br><span class="line">                    .setName(<span class="string">"allen"</span>)</span><br><span class="line">                    .build());</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            System.out.println(<span class="string">"Reply:"</span> + reply);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            t.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 程序入口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args 入口参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ApiConsumer consumer = <span class="keyword">new</span> ApiConsumer();</span><br><span class="line">        System.out.println(<span class="string">"dubbo triple consumer started"</span>);</span><br><span class="line"></span><br><span class="line">        consumer.sayHello();</span><br><span class="line">        consumer.bidiHello();</span><br><span class="line">        consumer.lotsOfReplies();</span><br><span class="line">        consumer.lotsOfGreetings();</span><br><span class="line"></span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="服务端代码"><a href="#服务端代码" class="headerlink" title="服务端代码"></a>服务端代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 服务实现代码</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Greeter1Impl</span> <span class="keyword">implements</span> <span class="title">IGreeter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HelloReply <span class="title">sayHello</span><span class="params">(HelloRequest request)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> HelloReply.newBuilder()</span><br><span class="line">                .setMessage(request.getName())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HelloReply <span class="title">sayHelloException</span><span class="params">(HelloRequest request)</span> </span>&#123;</span><br><span class="line">        RpcContext.getServerContext().setAttachment(<span class="string">"str"</span>, <span class="string">"str"</span>)</span><br><span class="line">                .setAttachment(<span class="string">"integer"</span>, <span class="number">1</span>)</span><br><span class="line">                .setAttachment(<span class="string">"raw"</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Biz Exception"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> StreamObserver&lt;HelloRequest&gt; <span class="title">bidiHello</span><span class="params">(StreamObserver&lt;HelloReply&gt; replyStream)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> StreamObserver&lt;HelloRequest&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(HelloRequest data)</span> </span>&#123;</span><br><span class="line">                replyStream.onNext(HelloReply.newBuilder()</span><br><span class="line">                        .setMessage(data.getName())</span><br><span class="line">                        .build());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">                throwable.printStackTrace();</span><br><span class="line">                replyStream.onError(<span class="keyword">new</span> IllegalStateException(<span class="string">"Stream err"</span>));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                replyStream.onCompleted();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lotsOfReplies</span><span class="params">(HelloRequest request, StreamObserver&lt;HelloReply&gt; replyStream)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            replyStream.onNext(HelloReply.newBuilder()</span><br><span class="line">                    .setMessage(request.getName())</span><br><span class="line">                    .build());</span><br><span class="line">        &#125;</span><br><span class="line">        replyStream.onCompleted();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> StreamObserver&lt;HelloRequest&gt; <span class="title">lotsOfGreetings</span><span class="params">(StreamObserver&lt;HelloReply&gt; replyStream)</span> </span>&#123;</span><br><span class="line">        StdoutStreamObserver stdoutStreamObserver = <span class="keyword">new</span> StdoutStreamObserver(<span class="string">"lotsOfGreetings"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> StreamObserver&lt;HelloRequest&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(HelloRequest data)</span> </span>&#123;</span><br><span class="line">                stdoutStreamObserver.onNext(data.getName());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">                throwable.printStackTrace();</span><br><span class="line">                stdoutStreamObserver.onError(<span class="keyword">new</span> IllegalStateException(<span class="string">"Stream err"</span>));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                HelloReply reply = HelloReply.newBuilder().setMessage(<span class="string">"completed,lotsOfGreetings"</span>).build();</span><br><span class="line"></span><br><span class="line">                replyStream.onNext(reply);</span><br><span class="line">                replyStream.onCompleted();</span><br><span class="line"></span><br><span class="line">                stdoutStreamObserver.onCompleted();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 服务发布</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ApiProvider</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 内置 zk 注册中心</span></span><br><span class="line">        <span class="keyword">new</span> EmbeddedZooKeeper(TriSampleConstants.ZK_PORT, <span class="keyword">false</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 服务发布定义</span></span><br><span class="line">        ServiceConfig&lt;IGreeter&gt; service = <span class="keyword">new</span> ServiceConfig&lt;&gt;();</span><br><span class="line">        service.setInterface(IGreeter<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        service.setRef(<span class="keyword">new</span> Greeter1Impl());</span><br><span class="line">        service.setToken(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启动服务</span></span><br><span class="line">        DubboBootstrap bootstrap = DubboBootstrap.getInstance();</span><br><span class="line">        bootstrap.application(<span class="keyword">new</span> ApplicationConfig(<span class="string">"demo-provider"</span>))</span><br><span class="line">                .registry(<span class="keyword">new</span> RegistryConfig(TriSampleConstants.ZK_ADDRESS))</span><br><span class="line">                .protocol(<span class="keyword">new</span> ProtocolConfig(CommonConstants.TRIPLE, TriSampleConstants.SERVER_PORT))</span><br><span class="line">                .service(service)</span><br><span class="line">                .start()</span><br><span class="line">                .await();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>可以发现，不管在客户端还是服务端，对于异步和 stream 操作都是通过 StreamObserver 对象来实现，它跟 gRPC 中的是一致，用过 gRPC 的话，可以无缝衔接 Dubbo 的 Triple，使用方式及相关的类都是一样的。</p>
<p><strong>参考：</strong></p>
<hr>
<p><a href="https://dubbo.apache.org/zh/docs/" target="_blank" rel="noopener">1. dubbo 官方文档</a></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/11/14/grpc-overview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Noahsark">
      <meta itemprop="description" content="不畏将来，不念过往">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以太格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2021/11/14/grpc-overview/" class="post-title-link" itemprop="http://yoursite.com/index.html">RPC：gRPC</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2021-11-14 20:05:48" itemprop="dateCreated datePublished" datetime="2021-11-14T20:05:48+08:00">2021-11-14</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2021-11-27 14:26:59" itemprop="dateModified" datetime="2021-11-27T14:26:59+08:00">2021-11-27</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/RPC/" itemprop="url" rel="index"><span itemprop="name">RPC</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">67k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">1:01</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这篇文章内容主要包括：1）gRPC 基本介绍；2）Java gRPC 实例；3）HTTP2 协议介绍；4）gRPC over HTTP2，流协议的介绍；</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Wikipiedia 对 gRPC 的描述：</p>
<blockquote>
<p>gRPC (gRPC Remote Procedure Calls<a href="https://grpc.io/docs/what-is-grpc/core-concepts/" target="_blank" rel="noopener">1</a>) 是 Google 发起的一个开源远程过程调用 (Remote procedure call) 系统。该系统基于 HTTP/2 协议传输，使用 Protocol Buffers 作为接口描述语言。<br>提供的功能有：</p>
<ul>
<li>认证（ authentication）;</li>
<li>双向流（bidirectional streaming）;</li>
<li>流控制（flow control）;</li>
<li>超时（timeouts）。</li>
</ul>
</blockquote>
<p>在这篇文章重点是讲述基于 HTTP2 协议，如何实现双向流。</p>
<h2 id="Java-gRPC-实例"><a href="#Java-gRPC-实例" class="headerlink" title="Java gRPC 实例"></a>Java gRPC 实例</h2><p>在该实例中，构建工具使用 maven。</p>
<h3 id="引入-jar-包及编译插件"><a href="#引入-jar-包及编译插件" class="headerlink" title="引入 jar 包及编译插件"></a>引入 jar 包及编译插件</h3><p><strong>1. 引入 gRPC jar 包</strong></p>
<p>gRPC 使用的版本是 1.41.0<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">grpc.version</span>&gt;</span>1.41.0<span class="tag">&lt;/<span class="name">grpc.version</span>&gt;</span><span class="comment">&lt;!-- CURRENT_GRPC_VERSION --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">protoc.version</span>&gt;</span>3.17.2<span class="tag">&lt;/<span class="name">protoc.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">netty.tcnative.version</span>&gt;</span>2.0.34.Final<span class="tag">&lt;/<span class="name">netty.tcnative.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.9<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.9<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-protobuf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-stub<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>annotations-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.53<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span> <span class="comment">&lt;!-- not needed at runtime --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-netty<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-tcnative-boringssl-static<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;netty.tcnative.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.26<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-bom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;grpc.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><strong>2. 引入 Java gRPC 编译插件</strong></p>
<p>编译插件主要是根据接口定义文件自动生成客户端及服务端代码，接口文件放在工程源代码目录下：src/main/proto，生成的代码位于如下目录：target/generated-sources/protobuf。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">extensions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">extension</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>kr.motd.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>os-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">extension</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">extensions</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.xolstice.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protobuf-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">protocArtifact</span>&gt;</span>com.google.protobuf:protoc:$&#123;protoc.version&#125;:exe:$&#123;os.detected.classifier&#125;</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">protocArtifact</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">pluginId</span>&gt;</span>grpc-java<span class="tag">&lt;/<span class="name">pluginId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">pluginArtifact</span>&gt;</span>io.grpc:protoc-gen-grpc-java:$&#123;grpc.version&#125;:exe:$&#123;os.detected.classifier&#125;</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">pluginArtifact</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile-custom<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>执行 mvn package 命令便生成 gRPC 相关的代码。</p>
<h3 id="定义接口文件"><a href="#定义接口文件" class="headerlink" title="定义接口文件"></a>定义接口文件</h3><p>接口文件使用 Protocol Buffers 定义，在这里定义了一个 Greeter 服务，它提供了 gRPC 支持的四种通信模式：</p>
<ol>
<li>SayHello, 实现 request-response 模式；</li>
<li>LotsOfReplies, 实现 request-stream 模式；</li>
<li>LotsOfGreetings, 实现 stream-response 模式；</li>
<li>BidiHello, 实现 stream-stream 模式。</li>
</ol>
<p>其中, HelloRequest 是请求消息，HelloReply 是响应结果。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"></span><br><span class="line">option java_multiple_files = <span class="literal">true</span>;</span><br><span class="line">option java_package = <span class="string">"org.noahsark.examples.helloworld"</span>;</span><br><span class="line">option java_outer_classname = <span class="string">"HelloWorldProto"</span>;</span><br><span class="line">option objc_class_prefix = <span class="string">"HLW"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> helloworld;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接口定义</span></span><br><span class="line">service Greeter &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// request &lt;--&gt; response</span></span><br><span class="line">  rpc SayHello(HelloRequest) returns (HelloReply) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// request &lt;--&gt; stream</span></span><br><span class="line">  rpc LotsOfReplies(HelloRequest) returns (stream HelloReply)&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// stream &lt;--&gt; response</span></span><br><span class="line">  rpc LotsOfGreetings(stream HelloRequest) returns (HelloReply) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// stream &lt;--&gt; stream</span></span><br><span class="line">   rpc BidiHello(stream HelloRequest) returns (stream HelloReply) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 请求消息</span></span><br><span class="line">message HelloRequest &#123;</span><br><span class="line">  <span class="keyword">string</span> name = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 响应消息</span></span><br><span class="line">message HelloReply &#123;</span><br><span class="line">  <span class="keyword">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>stream 的处理逻辑主要通过 StreamObserver 接口来实现，只要持有该对象，我们就可以接收和发送 stream 数据，其定义如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StreamObserver</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onNext</span><span class="params">(V var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中：</p>
<ul>
<li>onNext: 接收或发送下一个数据；</li>
<li>onError: 接收或发送一个异常；</li>
<li>onCompleted: 结束流操作。</li>
</ul>
<h3 id="客户端代码"><a href="#客户端代码" class="headerlink" title="客户端代码"></a>客户端代码</h3><p>通过代码可以看到，gRPC 提供了两类连接服务器的客户端代码：GreeterBlockingStub 和 GreeterStub，它们的区别是阻塞和非阻塞，其中，除了 request-response 可以使用阻塞式的客户端，有 stream 的请求都是使用非阻塞的。stream 的操作通过 StreamObserver 实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldClient</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(HelloWorldClient<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 同步客户端(stub),由 gRPC 编译器生成</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GreeterGrpc.GreeterBlockingStub blockingStub;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 异步客户端(stub),由 gRPC 编译器生成</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GreeterGrpc.GreeterStub stub;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造函数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channel gRPC channel</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HelloWorldClient</span><span class="params">(Channel channel)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        blockingStub = GreeterGrpc.newBlockingStub(channel);</span><br><span class="line">        stub = GreeterGrpc.newStub(channel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * request-response</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"Send a sayHello request ..."</span>);</span><br><span class="line"></span><br><span class="line">        HelloRequest request = HelloRequest.newBuilder().setName(<span class="string">"Allen"</span>).build();</span><br><span class="line">        HelloReply response;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            response = blockingStub.sayHello(request);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (StatusRuntimeException e) &#123;</span><br><span class="line">            logger.info(<span class="string">"RPC failed: &#123;0&#125;"</span>, e.getStatus());</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        logger.info(<span class="string">"Greeting: "</span> + response.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * request-stream</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lotsOfReplies</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"Send lotsOfReplies request......"</span>);</span><br><span class="line"></span><br><span class="line">        HelloRequest request = HelloRequest.newBuilder()</span><br><span class="line">                .setName(<span class="string">"Allen"</span>)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        StreamObserver&lt;HelloReply&gt; response = <span class="keyword">new</span> StdoutStreamObserver(<span class="string">"lotsOfReplies"</span>);</span><br><span class="line"></span><br><span class="line">        stub.lotsOfReplies(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * stream-stream</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bidiHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">"send bidiHello......"</span>);</span><br><span class="line"></span><br><span class="line">        StreamObserver&lt;HelloReply&gt; response = <span class="keyword">new</span> StdoutStreamObserver(<span class="string">"bidiHello"</span>);</span><br><span class="line">        <span class="keyword">final</span> StreamObserver&lt;HelloRequest&gt; request = stub.bidiHello(response);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            HelloRequest helloRequest = HelloRequest.newBuilder()</span><br><span class="line">                    .setName(<span class="string">"Allen"</span>)</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">            logger.info(<span class="string">"send a request:&#123;&#125;"</span>, helloRequest.getName());</span><br><span class="line"></span><br><span class="line">            request.onNext(helloRequest);</span><br><span class="line">        &#125;</span><br><span class="line">        request.onCompleted();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * stream-response</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lotsOfGreetings</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">"send lotsOfGreetings......"</span>);</span><br><span class="line"></span><br><span class="line">        StreamObserver&lt;HelloReply&gt; response = <span class="keyword">new</span> StdoutStreamObserver(<span class="string">"lotsOfGreetings"</span>);</span><br><span class="line">        <span class="keyword">final</span> StreamObserver&lt;HelloRequest&gt; request = stub.lotsOfGreetings(response);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            HelloRequest helloRequest = HelloRequest.newBuilder()</span><br><span class="line">                    .setName(<span class="string">"Allen"</span>)</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">            logger.info(<span class="string">"Send a request:&#123;&#125;"</span>, helloRequest.getName());</span><br><span class="line"></span><br><span class="line">            request.onNext(helloRequest);</span><br><span class="line">        &#125;</span><br><span class="line">        request.onCompleted();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 程序入口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args 启动参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception 运行异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// Access a service running on the local machine on port 50051</span></span><br><span class="line">        String target = <span class="string">"localhost:50051"</span>;</span><br><span class="line"></span><br><span class="line">        ManagedChannel channel = ManagedChannelBuilder.forTarget(target)</span><br><span class="line">                .usePlaintext()</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            HelloWorldClient client = <span class="keyword">new</span> HelloWorldClient(channel);</span><br><span class="line">            client.sayHello();</span><br><span class="line">            client.lotsOfReplies();</span><br><span class="line">            client.lotsOfGreetings();</span><br><span class="line">            client.bidiHello();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// pause program ...</span></span><br><span class="line">            <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>).await(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            logger.warn(<span class="string">"stop the program."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="服务端代码"><a href="#服务端代码" class="headerlink" title="服务端代码"></a>服务端代码</h3><p>gRPC 提供了服务器 Sever 的实现，对于开发者而言，只要提供一个接口的实现类，如 GreeterImpl, 并注册到 Sever 中即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(HelloWorldServer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// gRPC server</span></span><br><span class="line">    <span class="keyword">private</span> Server server;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服务实现类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">GreeterImpl</span> <span class="keyword">extends</span> <span class="title">GreeterGrpc</span>.<span class="title">GreeterImplBase</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">(HelloRequest req, StreamObserver&lt;HelloReply&gt; responseObserver)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            logger.info(<span class="string">"Recevice an unary rpc:&#123;&#125;"</span>, req.getName());</span><br><span class="line">            HelloReply reply = HelloReply.newBuilder().setMessage(<span class="string">"Hello "</span> + req.getName()).build();</span><br><span class="line"></span><br><span class="line">            responseObserver.onNext(reply);</span><br><span class="line">            responseObserver.onCompleted();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lotsOfReplies</span><span class="params">(HelloRequest request, StreamObserver&lt;HelloReply&gt; responseObserver)</span> </span>&#123;</span><br><span class="line">            logger.info(<span class="string">"receive an request in lotsOfReplies."</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                responseObserver.onNext(HelloReply.newBuilder()</span><br><span class="line">                        .setMessage(<span class="string">"Hello "</span> + request.getName())</span><br><span class="line">                        .build());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            responseObserver.onCompleted();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> StreamObserver&lt;HelloRequest&gt; <span class="title">bidiHello</span><span class="params">(StreamObserver&lt;HelloReply&gt; responseObserver)</span> </span>&#123;</span><br><span class="line">            logger.info(<span class="string">"receive an request in bidiHello."</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> StreamObserver&lt;HelloRequest&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(HelloRequest data)</span> </span>&#123;</span><br><span class="line">                    responseObserver.onNext(HelloReply.newBuilder()</span><br><span class="line">                            .setMessage(<span class="string">"Hello "</span> + data.getName())</span><br><span class="line">                            .build());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">                    throwable.printStackTrace();</span><br><span class="line">                    responseObserver.onError(<span class="keyword">new</span> IllegalStateException(<span class="string">"Stream err"</span>));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    responseObserver.onCompleted();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> StreamObserver&lt;HelloRequest&gt; <span class="title">lotsOfGreetings</span><span class="params">(StreamObserver&lt;HelloReply&gt; responseObserver)</span> </span>&#123;</span><br><span class="line">            logger.info(<span class="string">"receive an request in lotsOfGreetings."</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> StreamObserver&lt;HelloRequest&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(HelloRequest data)</span> </span>&#123;</span><br><span class="line">                    logger.info(<span class="string">"receive a message:&#123;&#125;"</span>, data.getName());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">                    throwable.printStackTrace();</span><br><span class="line">                    responseObserver.onError(<span class="keyword">new</span> IllegalStateException(<span class="string">"Stream err"</span>));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    HelloReply reply = HelloReply.newBuilder().setMessage(<span class="string">"completed,lotsOfGreetings"</span>).build();</span><br><span class="line"></span><br><span class="line">                    responseObserver.onNext(reply);</span><br><span class="line">                    responseObserver.onCompleted();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启动服务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">/* The port on which the server should run */</span></span><br><span class="line">        <span class="keyword">int</span> port = <span class="number">50051</span>;</span><br><span class="line">        server = ServerBuilder.forPort(port)</span><br><span class="line">                .addService(<span class="keyword">new</span> GreeterImpl()) <span class="comment">// 注册服务实现类</span></span><br><span class="line">                .build()</span><br><span class="line">                .start();</span><br><span class="line">        logger.info(<span class="string">"Server started, listening on "</span> + port);</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">// Use stderr here since the logger may have been reset by its JVM shutdown hook.</span></span><br><span class="line">                System.err.println(<span class="string">"*** shutting down gRPC server since JVM is shutting down"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    HelloWorldServer.<span class="keyword">this</span>.stop();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace(System.err);</span><br><span class="line">                &#125;</span><br><span class="line">                System.err.println(<span class="string">"*** server shut down"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服务关闭</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InterruptedException 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (server != <span class="keyword">null</span>) &#123;</span><br><span class="line">            server.shutdown().awaitTermination(<span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 阻塞服务器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InterruptedException 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">blockUntilShutdown</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (server != <span class="keyword">null</span>) &#123;</span><br><span class="line">            server.awaitTermination();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 程序入口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args 入口参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException IO 异常</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InterruptedException 中断异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> HelloWorldServer server = <span class="keyword">new</span> HelloWorldServer();</span><br><span class="line">        server.start();</span><br><span class="line">        server.blockUntilShutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="HTTP2"><a href="#HTTP2" class="headerlink" title="HTTP2"></a>HTTP2</h2><p>gRPC 底层的通信协议是 HTTP2，其 stream 的特性就是基于 HTTP2 stream 来实现的，要理解 gRPC 的实现，首先先要理解 HTTP2 协议。</p>
<h3 id="HTTP-演进"><a href="#HTTP-演进" class="headerlink" title="HTTP 演进"></a>HTTP 演进</h3><p>HTTP 内容比较多，每一次版本升级的特性也比较多，我们在这里仅仅选择“连接复用”的角度来阐述 HTTP 的演进。 </p>
<p><strong>HTTP 1.0</strong><br>在 HTTP 1.0 协议中，一个 TCP 连接只承载了一次网络请求，TCP 的复用率比较低，如下图所示：<br><img src="/images/rpc/http1.0.jpg" alt="http1.0" title="http1.0"></p>
<p>在这种场景下，建立 tcp 连接占了较大一部分开销，为了提高 TCP 的复用率，HTTP 1.1 引入了“持久连接”和“管道”的技术。</p>
<p><strong>HTTP 1.1</strong><br>在 HTTP 1.1 协议中，一个 TCP 连接可以被多个 HTTP 请求共享，这些请求是按序发送，下一个请求必须在上一个请求收到响应之后才能发送，如下图所示：</p>
<p><img src="/images/rpc/http1.1.jpg" alt="http1.1" title="http1.1"></p>
<p>为了提高发送的效率，HTTP 1.1 引入了“管道”技术，可以并行地发送多个 HTTP 请求，而不用等待上一个请求的响应。但响应结果仍然是有序的，即上一个请求的响应发送之后，才能发送下一个请求的响应。这就引发了 HTTP 的队头阻塞（head-of-line blocking）问题，上一个请求的响应会影响后续的响应。如果前一个请求的结果比较大，就会阻塞后续请求的响应。</p>
<p><strong>HTTP 2.0</strong><br>HTTP 2.0 为了解决 HTTP 队头阻塞的问题，引入了 stream 的概念。将一个 TCP 连接逻辑划分为多个 stream，每一个 stream 可独立负责一个 HTTP 请求，这些 stream 之间，1）可并行交错地发送多个请求，请求之间互不影响；2）可并行交错地发送多个响应，响应之间互不干扰；3）使用一个连接并行发送多个请求和响应。如下图所示：</p>
<p><img src="/images/rpc/http2-multiplexing.svg" alt="http2-multiplexing" title="http2-multiplexing"></p>
<p>HTTP 2.0 解决了 HTTP 队头阻塞的问题，但由于 HTTP 2.0 底层传输协议仍然是 TCP 协议，TCP 协议本身也有队头阻塞（head-of-line blocking）问题，其主要原因是数据包超时确认或丢失阻塞了滑动窗口向右滑动，阻塞了后续数据的发送，如下图所示：</p>
<p><img src="/images/rpc/tcp-sliding-window-v1.jpg" alt="tcp-sliding-window-v1" title="tcp-sliding-window-v1"></p>
<p>未收到 ACK 确认的消息将会占用滑动窗口，压缩了可发送窗口的大小。</p>
<p><strong>HTTP 3.0</strong><br>由于 TCP 存在队头阻塞的问题，下一代的 HTTP 3.0 将可能改用 UDP 协议，如 QUIC，它在 UDP 的基础上实现类似 TCP connection 的概念。</p>
<h3 id="HTTP2-功能"><a href="#HTTP2-功能" class="headerlink" title="HTTP2 功能"></a>HTTP2 功能</h3><p>相比于 HTTP 1.0, HTTP2 所有的数据使用二进制帧进行封装，极大地提高了客户端与服务器之间的传输效率，如下图所示:<br><img src="/images/rpc/binary_framing_layer01.svg" alt="binary_framing_layer01" title="binary_framing_layer01"></p>
<p>在 HTTP2 中有三个重要的概念：</p>
<ul>
<li>数据流(stream): 已建立的连接内的双向字节流，可以承载一条或多条消息；</li>
<li>消息(message): 与逻辑请求或响应消息对应的完整的一系列帧；</li>
<li>帧(frame):HTTP2 通信的最小单位，每个帧都包含帧头，至少也会标识出当前帧所属的数据流。</li>
</ul>
<p>它们之间的关系如下：</p>
<ul>
<li>所有通信都在一个 TCP 连接上完成，此连接可以承载任意数量的双向数据流；</li>
<li>每个数据流都有一个唯一的标识符和可选的优先级信息，用于承载双向消息；</li>
<li>每条消息都是一条逻辑 HTTP 消息（例如请求或响应），包含一个或多个帧；</li>
<li>帧是最小的通信单位，承载着特定类型的数据，例如 HTTP 标头、消息负载等等。 来自不同数据流的帧可以交错发送，然后再根据每个帧头的数据流标识符重新组装。</li>
</ul>
<p><img src="/images/rpc/streams_messages_frames01.svg" alt="streams_messages_frames01" title="streams_messages_frames01"></p>
<p>在一个 TCP 连接上承载了不同的 HTTP 请求，互不干扰。</p>
<p><strong>二进制帧协议</strong><br>一个二进制帧包括两个部分，一个是 8 字节的首部，其中包含帧的长度、类型、标志，还有一个保留位和一个31位的流标识符；另外一部分是实际传输的数据，如下图所示：</p>
<p><img src="/images/rpc/http2-binary-frame-format.png" alt="http2-binary-frame-format." title="http2-binary-frame-format"></p>
<p>首部的定义如下：</p>
<ul>
<li>16 位的长度意味着一帧可以携带最大 64 KB 的数据，不包括 8 字节首部；</li>
<li>8 位的类型字段决定如何解释帧的内容；</li>
<li>8 位的标志位字段允许不同的帧类型定义特定于帧的消息标志，<strong><font color="red">流的结束可以通过标志位来表示</font></strong>；</li>
<li>1 位的保留字段始终置为 0；</li>
<li>31 位的流标识字段唯一标识 HTTP 2.0 的流。</li>
</ul>
<p>其中帧类型可以分为：</p>
<ul>
<li>DATA：用于传输 HTTP 消息体；</li>
<li>HEADERS：用于传输 HTTP header；</li>
<li>SETTINGS：用于约定客户端和服务端的配置数据；</li>
<li>WINDOW_UPDATE：用于调整个别流或个别连接的流量；</li>
<li>PRIORITY： 用于指定或重新指定引用资源的优先级；</li>
<li>RST_STREAM： 用于通知流的非正常终止；</li>
<li>PUSH_PROMISE： 服务端推送许可；</li>
<li>PING：用于计算往返时间，用于保活；</li>
<li>GOAWAY：用于通知对端停止在当前连接中创建流；</li>
<li>CONTINUATION：用于继续一系列的 HEADERS。</li>
</ul>
<h2 id="gRPC-over-HTTP2"><a href="#gRPC-over-HTTP2" class="headerlink" title="gRPC over HTTP2"></a>gRPC over HTTP2</h2><p>gRPC 通常有四种模式，unary,client streaming,server streaming 以及 bidirectional streaming，对应 request-response, stream-response, request-stream 及 stream-stream， 对于底层 HTTP/2 来说，它们都是 stream，并且仍然是一套 request + response 模型。</p>
<h3 id="通信协议"><a href="#通信协议" class="headerlink" title="通信协议"></a>通信协议</h3><p>gRPC 协议中的 Request 及 Response 定义如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Request → Request-Headers *Length-Prefixed-Message EOS</span><br><span class="line">Response → (Response-Headers *Length-Prefixed-Message Trailers) / Trailers-Only</span><br></pre></td></tr></table></figure></p>
<p>Request 主要包含三个部分：1）一个消息头： Request-Headers; 2）消息内容：0 或 多个 Length-Prefixed-Message; 3）EOS（end-of-stream）: 用来表示 stream 不会在发送任何数据，可以关闭了。 </p>
<p>Response 主要包含三个部分：1）一个消息头：Response-Headers; 2) 消息内容：0 或 多个 Length-Prefixed-Message; 3）Trailers; 如果报错了，只会返回 Trailers-Only，在 Trailers 中会包含 stream 结束标志。</p>
<p>在 Protocol Buffers 定义的方法可以很方便地跟 HTTP2 中的相关 Header 关联起来：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Path : /Service-Name/&#123;method name&#125;</span><br><span class="line">Service-Name : ?( &#123;proto <span class="keyword">package</span> name&#125; <span class="string">"."</span> ) &#123;service name&#125;</span><br><span class="line">Message-Type : &#123;fully qualified proto message name&#125;</span><br><span class="line">Content-Type : <span class="string">"application/grpc+proto"</span></span><br></pre></td></tr></table></figure></p>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><p>以官方给的 unary 为例，其消息包含如下内容：</p>
<p><strong>Request:</strong><br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">HEADERS (flags = END_HEADERS)</span><br><span class="line">:method = POST</span><br><span class="line">:scheme = http</span><br><span class="line">:path = /google.pubsub.v2.PublisherService/CreateTopic</span><br><span class="line">:authority = pubsub.googleapis.com</span><br><span class="line">grpc-timeout = <span class="number">1</span>S</span><br><span class="line">content-<span class="keyword">type</span> = application/grpc+proto</span><br><span class="line">grpc-encoding = gzip</span><br><span class="line">authorization = Bearer y235.wef315yfh138vh31hv93hv8h3v</span><br><span class="line"></span><br><span class="line">DATA (flags = END_STREAM)</span><br><span class="line">&lt;Length-Prefixed Message&gt;</span><br></pre></td></tr></table></figure></p>
<p><strong>Response:</strong><br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">HEADERS (flags = END_HEADERS)</span><br><span class="line">:status = <span class="number">200</span></span><br><span class="line">grpc-encoding = gzip</span><br><span class="line">content-<span class="keyword">type</span> = application/grpc+proto</span><br><span class="line"></span><br><span class="line">DATA</span><br><span class="line">&lt;Length-Prefixed Message&gt;</span><br><span class="line"></span><br><span class="line">HEADERS (flags = END_STREAM, END_HEADERS)</span><br><span class="line">grpc-status = <span class="number">0</span> # OK</span><br><span class="line">trace-proto-bin = jher831yy13JHy3hc</span><br></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>gRPC 基于底层 HTTP2 协议实现了 stream 的操作，换句话说，gRPC 不能脱离 Http2 单独存在，这跟 Rscoket 的设计理念是不一样的，Rscoket 是一种应用层协议，它对底层协议没有限制，只要支持 “连接” 的概念，甚至可以基于 UDP 来实现。从这一点来说，gRPC 跟 HTTP2 协议是强依赖的。</p>
<p><br></p>
<p><strong>参考：</strong></p>
<hr>
<p><a href="https://grpc.io/docs/what-is-grpc/core-concepts/" target="_blank" rel="noopener">1. Core concepts, architecture and lifecycle</a><br><a href="https://zh.wikipedia.org/wiki/GRPC" target="_blank" rel="noopener">2. gRPC</a><br><a href="https://blog.csdn.net/zhuyiquan/article/details/69257126?utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-1.control&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-1.control" target="_blank" rel="noopener">3. HTTP 2.0 原理详细分析</a><br><a href="https://www.cnblogs.com/xiaolincoding/p/12732052.html" target="_blank" rel="noopener">4. 30张图解：TCP 重传、滑动窗口、流量控制、拥塞控制</a><br><a href="https://developers.google.com/web/fundamentals/performance/http2?hl=zh-cn" target="_blank" rel="noopener">5. HTTP/2 简介</a><br><a href="https://github.com/grpc/grpc/blob/master/doc/PROTOCOL-HTTP2.md" target="_blank" rel="noopener">6. gRPC over HTTP2</a><br><a href="https://pingcap.com/zh/blog/grpc" target="_blank" rel="noopener">7. 深入了解 gRPC：协议</a></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/11/07/rpc-overview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Noahsark">
      <meta itemprop="description" content="不畏将来，不念过往">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以太格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2021/11/07/rpc-overview/" class="post-title-link" itemprop="http://yoursite.com/index.html">RPC：RPC 概述</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2021-11-07 20:04:33" itemprop="dateCreated datePublished" datetime="2021-11-07T20:04:33+08:00">2021-11-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2021-11-14 19:58:30" itemprop="dateModified" datetime="2021-11-14T19:58:30+08:00">2021-11-14</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/RPC/" itemprop="url" rel="index"><span itemprop="name">RPC</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">14k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">12 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这篇文章是 RPC 系列的第一篇，打算写一个系列的文章，简单介绍下 Duboo2, Dubbo3, gRPC 及 RScoket 的使用方法及差异。在 Alligator 项目中借鉴了其中的一些思想，基于 TCP, Websocket 及 MQ，实现了一个简单的 RPC。RPC 涉及到内容比较多，这里选取了两个方面做为切入点：1）通信模式，包括 request-response, request-stream, stream-response, stream-stream, send-oneway; 2）协议，主要是协议字段，通过这些字段可以大概猜测出其实现方式。</p>
<h2 id="一句话-RPC"><a href="#一句话-RPC" class="headerlink" title="一句话 RPC"></a>一句话 RPC</h2><p>Wikipedia 对 RPC 的解释：</p>
<blockquote>
<p>In distributed computing, a remote procedure call (RPC) is when a computer program causes a procedure (subroutine) to execute in a different address space (commonly on another computer on a shared network), which is coded as if it were a normal (local) procedure call, without the programmer explicitly coding the details for the remote interaction. </p>
</blockquote>
<p>这里有几个重点：</p>
<ol>
<li>RPC 调用通常是不同进程间的调用，而这些进程一般通过网络进行连接；</li>
<li>对上层应用而言，本地调用与远程调用在使用方式上没有差异；</li>
<li>RPC 封装了底层通信的细节，不需要开发人员显示地编码。</li>
</ol>
<p>下面以一个例子说明：</p>
<p><strong>接口定义：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface HelloService &#123;</span><br><span class="line">    String sayHello(String message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>客户端：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        HelloService helloService = getProxy(HelloService.class,"127.0.0.1",10240);</span><br><span class="line">        String result = helloService.sayHello(<span class="string">"hi, charles"</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"result = "</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>  &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Class&lt;T&gt; interfaceClass, String host, <span class="keyword">int</span> port)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (T) Proxy.newProxyInstance(interfaceClass.getClassLoader(),</span><br><span class="line">                <span class="keyword">new</span> Class&lt;?&gt;[] &#123;interfaceClass&#125;,</span><br><span class="line">                <span class="keyword">new</span> InvocationHandler() &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[]</span></span></span><br><span class="line"><span class="function"><span class="params">                            arguments)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                        Socket socket = <span class="keyword">new</span> Socket(host, port);</span><br><span class="line">                        ObjectOutputStream output = <span class="keyword">new</span> ObjectOutputStream(socket.getOutputStream());</span><br><span class="line"></span><br><span class="line">                        output.writeUTF(method.getName());</span><br><span class="line">                        output.writeObject(method.getParameterTypes());</span><br><span class="line">                        output.writeObject(arguments);</span><br><span class="line"></span><br><span class="line">                        ObjectInputStream input = <span class="keyword">new</span></span><br><span class="line">                                ObjectInputStream(socket.getInputStream());</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">return</span> input.readObject();&#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在客户端为接口生成一个代理，并将方法名及参数序列化之后，通过一定的协议发送给服务器，最后同步读取服务端返回的数据作为方法的响应。</p>
<p><strong>服务器：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 接口实现类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloServiceImpl</span> <span class="keyword">implements</span> <span class="title">HelloService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 服务器</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> port = <span class="number">10240</span>;</span><br><span class="line">        HelloService service = <span class="keyword">new</span> HelloServiceImpl();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"server startup..."</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ServerSocket server = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">            <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">                <span class="keyword">final</span> Socket socket = server.accept();</span><br><span class="line">                <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        ObjectInputStream input = <span class="keyword">new</span> ObjectInputStream(socket.getInputStream());</span><br><span class="line"></span><br><span class="line">                        String methodName = input.readUTF();</span><br><span class="line">                        Class&lt;?&gt;[] parameterTypes = (Class&lt;?&gt;[]) input.readObject();</span><br><span class="line">                        Object[] arguments = (Object[]) input.readObject();</span><br><span class="line"></span><br><span class="line">                        System.out.println(<span class="string">"receive request:"</span>);</span><br><span class="line">                        System.out.println(<span class="string">"method:"</span> + methodName);</span><br><span class="line"></span><br><span class="line">                        ObjectOutputStream output = <span class="keyword">new</span> ObjectOutputStream(socket.getOutputStream());</span><br><span class="line">                        Method method = service.getClass().getMethod(methodName,parameterTypes);</span><br><span class="line"></span><br><span class="line">                        Object result = method.invoke(service, arguments);</span><br><span class="line">                        System.out.println(<span class="string">"result = "</span> + result);</span><br><span class="line"></span><br><span class="line">                        output.writeObject(result);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                        ex.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;).start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在服务端实现接口，监听网络的请求，按照协议，反序列化方法名及参数，并通过反射的方式映射到具体的接口实现，转换为本地方法调用，调用结束之后，再将结果返回给客户端。</p>
<p>一句话总结：RPC 就是一种网络编程技术，结合代理、序列化/反序列技术，通过一定的通信协议，实现类似本地方法调用的功能。</p>
<h2 id="通信模式"><a href="#通信模式" class="headerlink" title="通信模式"></a>通信模式</h2><p>RPC 一般有如下五种通信模式。</p>
<h3 id="Send-Oneway"><a href="#Send-Oneway" class="headerlink" title="Send-Oneway"></a>Send-Oneway</h3><p>特点：只发送请求数据，服务器不需要响应，适用于发送一些不关键的数据，如日志上报。<br><img src="/images/rpc/send-oneway.jpg" alt="send-oneway" title="send-oneway"></p>
<h3 id="Request-Response"><a href="#Request-Response" class="headerlink" title="Request-Response"></a>Request-Response</h3><p>特点：最常见的模式，客户端发送一个请求，服务器响应一个结果。<br><img src="/images/rpc/unary-rpc.jpg" alt="unary-rpc" title="unary-rpc"></p>
<h3 id="Reqeust-Stream"><a href="#Reqeust-Stream" class="headerlink" title="Reqeust-Stream"></a>Reqeust-Stream</h3><p>特点：发送一个请求，可以返回多个响应结果。<br><img src="/images/rpc/request-stream-rpc.jpg" alt="request-stream-rpc" title="request-stream-rpc"></p>
<h3 id="Stream-Response"><a href="#Stream-Response" class="headerlink" title="Stream-Response"></a>Stream-Response</h3><p>特点：发送多个请求，响应一个结果。<br><img src="/images/rpc/stream-response-rpc.jpg" alt="stream-response-rpc" title="stream-response-rpc"></p>
<h3 id="Stream-Stream"><a href="#Stream-Stream" class="headerlink" title="Stream-Stream"></a>Stream-Stream</h3><p>特点：双向流的模式，客户端及服务器都向对方发送多个数据，互不干扰。<br><img src="/images/rpc/send-oneway.jpg" alt="stream-stream-rpc" title="stream-stream-rpc"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>一个完整的 RPC 流程包括三个步骤：</p>
<ol>
<li>定义接口：可以使用中间语言，也可以使用特定的语言定义，如 JAVA；</li>
<li>生成客户端代理：根据接口定义，通过代码生成客户端代理，它封装了向服务端请求的代码；</li>
<li>编写服务器接口实现：生成服务器通信代码及编写接口的实现。</li>
</ol>
<p>一个 RPC 框架通常提供代码生成的功能，客户端代理、服务器通信功能、序列化/反序列化的代码都会生成，开发者只需要编写接口定义及接口实现即可。</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/10/23/redis-6-2-docker-deployment/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Noahsark">
      <meta itemprop="description" content="不畏将来，不念过往">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以太格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2021/10/23/redis-6-2-docker-deployment/" class="post-title-link" itemprop="http://yoursite.com/index.html">Redis 6.2 Docker 部署（单机）</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2021-10-23 17:36:51" itemprop="dateCreated datePublished" datetime="2021-10-23T17:36:51+08:00">2021-10-23</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2021-10-30 20:44:51" itemprop="dateModified" datetime="2021-10-30T20:44:51+08:00">2021-10-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/部署/" itemprop="url" rel="index"><span itemprop="name">部署</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">6.6k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">6 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-拉取镜像"><a href="#1-拉取镜像" class="headerlink" title="1. 拉取镜像"></a>1. 拉取镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 搜索 Mysql 镜像</span></span><br><span class="line">$ docker search mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载 Redis 镜像</span></span><br><span class="line">$ docker pull redis:6.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看下载镜像</span></span><br><span class="line">$ docker images</span><br></pre></td></tr></table></figure>
<h2 id="2-创建挂载目录"><a href="#2-创建挂载目录" class="headerlink" title="2. 创建挂载目录"></a>2. 创建挂载目录</h2><p>在宿主机上创建 Reids 配置文件目录及数据目录。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /app/redis6.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 conf &amp; data 目录</span></span><br><span class="line">$ mkdir conf</span><br><span class="line">$ mkdir data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载 redis 配置文件</span></span><br><span class="line">$ <span class="built_in">cd</span> conf</span><br><span class="line">$ wget wget http://download.redis.io/redis-stable/redis.conf</span><br></pre></td></tr></table></figure></p>
<h2 id="3-修改-redis-conf-文件"><a href="#3-修改-redis-conf-文件" class="headerlink" title="3. 修改 redis.conf 文件"></a>3. 修改 redis.conf 文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 注释 bind,否则只允许本机访问</span></span><br><span class="line"><span class="comment"># bind 127.0.0.1 -::1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭安全模式</span></span><br><span class="line">protected-mode no</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启持久化（可选）</span></span><br><span class="line">appendonly yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后台运行</span></span><br><span class="line">daemonize yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志文件</span></span><br><span class="line">logfile <span class="string">"access.log"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置访问密码</span></span><br><span class="line">requirepass 123456</span><br></pre></td></tr></table></figure>
<h2 id="4-启动-Redis"><a href="#4-启动-Redis" class="headerlink" title="4. 启动 Redis"></a>4. 启动 Redis</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动 Redis 6.2</span></span><br><span class="line">$ docker run -d \</span><br><span class="line">-p 6379:6379 --name redis6.2 \</span><br><span class="line">-v /app/redis6.2/conf/redis.conf:/etc/redis/redis.conf \</span><br><span class="line">-v /app/redis6.2/data:/data \</span><br><span class="line">--privileged=<span class="literal">true</span> redis:6.2 redis-server \ </span><br><span class="line">/etc/redis/redis.conf --appendonly yes</span><br></pre></td></tr></table></figure>
<p><strong>参数说明：</strong></p>
<ul>
<li>–name：容器名称；</li>
<li>-p：端口映射，宿主机端口:容器端口；</li>
<li>-v：挂载宿主机目录，宿主机目录(或文件):容器目录(或文件)；</li>
<li>-d：后台运行</li>
<li>redis-server –appendonly yes： 在容器执行redis-server启动命令，并打开redis持久化配置</li>
</ul>
<p><strong>Redis 目录说明：</strong></p>
<ul>
<li>配置文件： /etc/redis/redis.conf</li>
<li>数据文件目录：/data</li>
</ul>
<p><strong>说明：</strong><br>Redis docker 镜像默认无配置文件。</p>
<h2 id="5-访问-Redis-容器"><a href="#5-访问-Redis-容器" class="headerlink" title="5. 访问 Redis 容器"></a>5. 访问 Redis 容器</h2><p>执行 <code>docker exec -it redis6.2 redis-cli</code> 命令，进入终端。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看容器列表</span></span><br><span class="line">$ docker ps</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入容器</span></span><br><span class="line">$ docker <span class="built_in">exec</span> -it redis6.2 redis-cli </span><br><span class="line">127.0.0.1:6379&gt; auth default 123456</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者使用 bash 命令</span></span><br><span class="line">$ docker <span class="built_in">exec</span> -it redis6.2 bash</span><br><span class="line">$ redis-cli</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong><br> 在 Redis6.0 之前的版本中，登陆 Redis Server 只需要输入密码（前提配置了密码 requirepass ）即可，不需要输入用户名，而且密码也是明文配置到配置文件中，安全性不高。另外应用连接也使用该密码，导致应用有所有权限，风险极高。在 Redis6.0 引入了 ACL，可以按照不同的需求设置相关的用户和权限。<br> Redis ACL 是向后兼容的，即默认情况下用户为 default，使用的是 requirepass 配置的密码。如果不配置密码，输入任何字符串都可以认证通过，包括空字符串（不过密码字段不能省略）。要是不使用ACL功能，对旧版客户端来说完全一样。</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/10/23/mysql-docker-deployment/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Noahsark">
      <meta itemprop="description" content="不畏将来，不念过往">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以太格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2021/10/23/mysql-docker-deployment/" class="post-title-link" itemprop="http://yoursite.com/index.html">Mysql 5.7 Docker 部署（单机）</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2021-10-23 11:19:50 / 修改时间：18:32:57" itemprop="dateCreated datePublished" datetime="2021-10-23T11:19:50+08:00">2021-10-23</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/部署/" itemprop="url" rel="index"><span itemprop="name">部署</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">8.2k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">7 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在项目开发中，有时需要用到 Mysql 来验证功能，使用 Docker 部署 Mysql 便是一个比较方便快捷的选择，在本文中主要是安装 Mysql 5.7，其它版本可以自行选择。</p>
<h2 id="1-拉取镜像"><a href="#1-拉取镜像" class="headerlink" title="1. 拉取镜像"></a>1. 拉取镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 搜索 Mysql 镜像</span></span><br><span class="line">$ docker search mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载 Mysql 5.7 镜像</span></span><br><span class="line">$ docker pull mysql:5.7</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看下载镜像</span></span><br><span class="line">$ docker images</span><br></pre></td></tr></table></figure>
<p><font color="red"><strong>Mysql 官方镜像地址:</strong></font><br><a href="https://hub.docker.com/_/mysql/" target="_blank" rel="noopener">https://hub.docker.com/_/mysql/</a></p>
<p><strong>说明：</strong><br>其它版本可以在官方网站查看</p>
<h2 id="2-启动镜像"><a href="#2-启动镜像" class="headerlink" title="2. 启动镜像"></a>2. 启动镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 运行 Mysql 容器</span></span><br><span class="line">$ docker run -d 3306:3306 --name mysql -e MYSQL_ROOT_PASSWORD=123456 mysql:5.7</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行 Mysql 容器，映射目录，设置 Mysql 参数</span></span><br><span class="line">$ docker run -d -p 3306:3306 --name mysql \</span><br><span class="line">-v /fsmeeting/mysql/conf:/etc/mysql \</span><br><span class="line">-v /fsmeeting/mysql/logs:/var/<span class="built_in">log</span>/mysql \</span><br><span class="line">-v /fsmeeting/mysql/data:/var/lib/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123456 \</span><br><span class="line">mysql:5.7 \</span><br><span class="line">--lower_case_table_names=1 \</span><br><span class="line">--character_set_server=utf8 \</span><br><span class="line">--innodb_log_file_size=256m</span><br></pre></td></tr></table></figure>
<p><strong>Docker 参数说明：</strong></p>
<ul>
<li>-d：后台运行容器，并返回容器 ID;</li>
<li>-p：指定端口映射，格式为：主机(宿主)端口 : 容器端口；</li>
<li>–name：容器名称，此处为 mysql;</li>
<li>-v：宿主机和容器的目录映射关系，格式为：宿主机目录 ：容器目录；</li>
<li>-e：设置环境变量，此处配置 Mysql 的 root 密码；</li>
</ul>
<p><strong>Mysql 目录说明：</strong></p>
<ul>
<li>配置文件目录：/etc/mysql</li>
<li>日志文件目录：/var/log/mysql</li>
<li>数据文件目录：/var/lib/mysql</li>
</ul>
<p><strong>Mysql 参数说明（根据需要配置）：</strong></p>
<ul>
<li>lower_case_table_names=1：设置表名参数名等忽略大小写；</li>
<li>max-allowed-packet=1073741824：设置最大插入和更新数据限制为 1G（1024 <em> 1024 </em> 1024 = 1073741824），单位：字节；</li>
<li>character_set_server=utf8：设置 utf8 字符集；</li>
<li>innodb_log_file_size=256m：设置日志文件大小；</li>
</ul>
<h2 id="3-访问-Mysql"><a href="#3-访问-Mysql" class="headerlink" title="3. 访问 Mysql"></a>3. 访问 Mysql</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入容器</span></span><br><span class="line">$ docker <span class="built_in">exec</span> -it mysql bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 容器内，访问 Mysql 服务</span></span><br><span class="line">$ mysql -uroot -p123456</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 root 用户允许远程访问</span></span><br><span class="line">&gt; GRANT ALL PRIVILEGES ON *.* TO <span class="string">'root'</span>@<span class="string">'%'</span> IDENTIFIED BY <span class="string">'123456'</span> WITH GRANT OPTION;</span><br><span class="line">&gt; FLUSH PRIVILEGES;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 宿主机上安装 Mysql 客户端</span></span><br><span class="line">$ rpm -ivh https://repo.mysql.com/mysql57-community-release-el7-11.noarch.rpm</span><br><span class="line">$ yum install mysql-community-client.x86_64</span><br><span class="line"></span><br><span class="line"><span class="comment"># 宿主机访问</span></span><br><span class="line">$ mysql -h 127.0.0.1 -uroot -p123456</span><br></pre></td></tr></table></figure>
<p><strong>Mysql 用户管理：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加用户，以 root 用户登陆到 mysql </span></span><br><span class="line"><span class="comment"># 格式：create user new_user identified by password;</span></span><br><span class="line">&gt; create user dev  identified by <span class="string">'123456'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 授权</span></span><br><span class="line"><span class="comment"># grant privilegesCode on dbName.tableName to username@host identified by "password";</span></span><br><span class="line">&gt; grant all privileges on *.* to dev@<span class="string">'%'</span> identified by <span class="string">'123456'</span>;</span><br><span class="line">&gt; flush privileges;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看用户信息</span></span><br><span class="line">&gt; select * from mysql.db <span class="built_in">where</span> User =<span class="string">'dev'</span></span><br></pre></td></tr></table></figure>
<p><strong>授权命令说明：</strong><br>命令格式：grant privilegesCode on dbName.tableName to username@host identified by “password”;</p>
<p><font color="red">privilegesCode</font> 表示授予的权限类型，常用的有以下几种类型：</p>
<ul>
<li>all privileges：所有权限；</li>
<li>select：读取权限；</li>
<li>delete：删除权限；</li>
<li>update：更新权限；</li>
<li>create：创建权限；</li>
<li>drop：删除数据库、数据表权限。</li>
</ul>
<p><font color="red">dbName.tableName</font> 表示授予权限的具体库或表，常用的有以下几种选项：</p>
<ul>
<li>*.*：授予该数据库服务器所有数据库的权限；</li>
<li>dbName.*：授予dbName数据库所有表的权限；</li>
<li>dbName.dbTable：授予数据库 dbName 中 dbTable 表的权限。</li>
</ul>
<p><font color="red">username@host</font> 表示授予的用户以及允许该用户登录的IP地址。其中Host有以下几种类型：</p>
<ul>
<li>localhost：只允许该用户在本地登录，不能远程登录。</li>
<li>%：允许在除本机之外的任何一台机器远程登录。</li>
<li>192.168.7.115：具体的 IP 表示只允许该用户从特定 IP 登录。</li>
</ul>
<p><font color="red">password:</font> 指定该用户登录时的面。</p>
<p><font color="red">flush privileges</font> 表示刷新权限变更。</p>
<p><br></p>
<p><strong>参考：</strong></p>
<hr>
<p><a href="https://hub.docker.com/_/mysql" target="_blank" rel="noopener">1. mysql Official Image</a></p>
<p><a href="https://www.cnblogs.com/sablier/p/11605606.html" target="_blank" rel="noopener">2. 使用Docker搭建MySQL服务</a></p>
<p><a href="https://www.cnblogs.com/chanshuyi/p/mysql_user_mng.html" target="_blank" rel="noopener">3. MySQL用户管理：添加用户、授权、删除用户</a></p>
<p><a href="https://linuxize.com/post/how-to-create-mysql-user-accounts-and-grant-privileges/" target="_blank" rel="noopener">4. How to Create MySQL Users Accounts and Grant Privileges</a></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/10/17/alligator-protocol-bufffer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Noahsark">
      <meta itemprop="description" content="不畏将来，不念过往">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以太格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2021/10/17/alligator-protocol-bufffer/" class="post-title-link" itemprop="http://yoursite.com/index.html">Alligator 系列：Protocol Buffer</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2021-10-17 15:11:22 / 修改时间：23:13:12" itemprop="dateCreated datePublished" datetime="2021-10-17T15:11:22+08:00">2021-10-17</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Alligator网关/" itemprop="url" rel="index"><span itemprop="name">Alligator网关</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">34k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">31 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h2><p>在系统中，Protocol Buffer 的使用有两种方式：1）定义 .proto 文件，生成相应的 Bean 对象及序列化的代码；2）根据现有的 Java Bean 对象，动态生成对应的 schema, 使用工具类完成对象的序列化。这两种方式的优缺点也比较明显，.proto 文件支持向前、向后兼容，后者使用简单，引用工具类，便可支持序列化操作，缺点是存在代码兼容性问题。</p>
<font color="red"><strong> 说明: </strong></font><br><font color="red">这篇文章只是简单讲述两种方式的使用，详细的内容请参考官方文档。</font>

<h2 id="2-定义-proto-文件"><a href="#2-定义-proto-文件" class="headerlink" title="2. 定义 proto 文件"></a>2. 定义 proto 文件</h2><h3 id="2-1-安装部署-Protocol-Buffer-编译器"><a href="#2-1-安装部署-Protocol-Buffer-编译器" class="headerlink" title="2.1 安装部署 Protocol Buffer 编译器"></a>2.1 安装部署 Protocol Buffer 编译器</h3><p>以 windows 环境为例，从官方下载 Protocol Buffer，如 protoc-3.18.1-win64.zip, 解压缩到指定目录，并将 bin 目录加到 Path 环境变量中即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SET PROTOC_HOME=D:\app\protoc-3.18.1-win64</span><br><span class="line">SET PATH=%PAHTH%;%PROTOC_HOME%\bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看版本</span></span><br><span class="line">C:\Users\Admin&gt;protoc --version</span><br><span class="line">libprotoc 3.18.1</span><br></pre></td></tr></table></figure>
<p><font color="red"><strong>下载地址:</strong></font><br><a href="ttps://github.com/protocolbuffers/protobuf/releases/tag/v3.18.1" target="_blank" rel="noopener">https://github.com/protocolbuffers/protobuf/releases/tag/v3.18.1</a></p>
<h3 id="2-2-定义-proto-文件"><a href="#2-2-定义-proto-文件" class="headerlink" title="2.2 定义 proto 文件"></a>2.2 定义 proto 文件</h3><p>在官方的 addressbook.proto 文件基础上，添加了 map 对象的变量 people_map，在真实场景中，该对象可以通过 peoples 列表遍历得到，不需要传递 map 对象，否则会传输两份数据，在这里仅仅是演示作用。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// [START declaration]</span></span><br><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"><span class="keyword">package</span> tutorial;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"google/protobuf/timestamp.proto"</span>;</span><br><span class="line"><span class="comment">// [END declaration]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// [START java_declaration]</span></span><br><span class="line">option java_multiple_files = <span class="literal">true</span>;</span><br><span class="line">option java_package = <span class="string">"com.example.tutorial.protos"</span>;</span><br><span class="line">option java_outer_classname = <span class="string">"AddressBookProtos"</span>;</span><br><span class="line"><span class="comment">// [END java_declaration]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// [START messages]</span></span><br><span class="line">message Person &#123;</span><br><span class="line">  <span class="keyword">string</span> name = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">int32</span> id = <span class="number">2</span>;  <span class="comment">// Unique ID number for this person.</span></span><br><span class="line">  <span class="keyword">string</span> email = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">  enum PhoneType &#123;</span><br><span class="line">    MOBILE = <span class="number">0</span>;</span><br><span class="line">    HOME = <span class="number">1</span>;</span><br><span class="line">    WORK = <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  message PhoneNumber &#123;</span><br><span class="line">    <span class="keyword">string</span> number = <span class="number">1</span>;</span><br><span class="line">    PhoneType <span class="keyword">type</span> = <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  repeated PhoneNumber phones = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">  google.protobuf.Timestamp last_updated = <span class="number">5</span>;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Our address book file.</span></span><br><span class="line">message AddressBook &#123;</span><br><span class="line">  repeated Person peoples = <span class="number">1</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">map</span>&lt;<span class="keyword">string</span>, Person&gt; people_map = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// [END messages]</span></span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li>syntax: PB 版本，有 v2 和 v3 两个版本，值分别为 proto2 和 proto3;</li>
<li>package: 包名，表示命名空间，用于解决名称冲突，在 Java 中转换为 package 包名；</li>
<li>java_multiple_files：Java 申明，若为 true, 表示为每一个 message 生成独立的文件（嵌套的 message 除外）；</li>
<li>java_package：Java 申明，指定 Java 的 package 名称，它为覆盖 package 属性指定的包名；</li>
<li>java_outer_classname：Java 申明，指定输出的 Java 类名；</li>
<li>import：引入外部的 proto 文件；</li>
<li>message：定义一个消息，对应 Java 中的对象，message 可以嵌套定义；</li>
<li>enum：枚举对象，下标从 0 开始；</li>
<li>repeated：表示 0 或 n 个对象，可以定义数组对象；</li>
<li>map：map 对象；</li>
<li>optional：描述符，表示该字段为可选字段，如果没有设置的话，使用默认值，在 proto3 中已经取消 required 字段；</li>
<li>tag：如同 =1,字段在 message 中的惟一标示，在二进制编码中使用 tag 代表该字段，1~15 使用一个字节表示，处于优化的目的，常用的字段应该放在这个区域。</li>
</ol>
<p>map 对象等同于如下的定义，它实际上就是一个包含 key 和 value 对象的数组。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">message MapFieldEntry &#123;</span><br><span class="line">  key_type key = <span class="number">1</span>;</span><br><span class="line">  value_type value = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">repeated MapFieldEntry map_field = N;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-3-编译-proto-文件"><a href="#2-3-编译-proto-文件" class="headerlink" title="2.3 编译 proto 文件"></a>2.3 编译 proto 文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc -I=. --java_out=. addressbookV2.proto</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ol>
<li>-I：指定 proto 文件所在的源目录；</li>
<li>–java_out：指定 Java 语言编译输出的目录；</li>
</ol>
<p>生成的代码如下所示：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">└─org</span><br><span class="line">    └─noahsark</span><br><span class="line">        └─tutorial</span><br><span class="line">            └─protos</span><br><span class="line">                    AddressBook.java</span><br><span class="line">                    AddressBookOrBuilder.java</span><br><span class="line">                    AddressBookProtos.java</span><br><span class="line">                    Person.java</span><br><span class="line">                    PersonOrBuilder.java</span><br></pre></td></tr></table></figure></p>
<h3 id="2-4-运行代码"><a href="#2-4-运行代码" class="headerlink" title="2.4 运行代码"></a>2.4 运行代码</h3><p>将生成的的代码导入工程，引入 Protocol Buffer jar 包。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.protobuf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protobuf-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.18.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><strong>构造 AddressBook 对象并序列化数据</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span> [] marshal() &#123;</span><br><span class="line">    <span class="comment">// 构造 Person 对象</span></span><br><span class="line">    Person john =</span><br><span class="line">            Person.newBuilder()</span><br><span class="line">                    .setId(<span class="number">1234</span>)</span><br><span class="line">                    .setName(<span class="string">"John Doe"</span>)</span><br><span class="line">                    .setEmail(<span class="string">"jdoe@example.com"</span>)</span><br><span class="line">                    .addPhones(</span><br><span class="line">                            Person.PhoneNumber.newBuilder()</span><br><span class="line">                                    .setNumber(<span class="string">"555-4321"</span>)</span><br><span class="line">                                    .setType(Person.PhoneType.HOME))</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造 AddressBook 对象</span></span><br><span class="line">    AddressBook addressBook = AddressBook.newBuilder()</span><br><span class="line">            .addPeoples(john)</span><br><span class="line">            .putPeopleMap(john.getName(),john).build();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 序列化 AddressBook 对象</span></span><br><span class="line">    <span class="keyword">byte</span> [] message = addressBook.toByteArray();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> message;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>反序列化 AddressBook 对象</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> AddressBook <span class="title">unmarshal</span><span class="params">(<span class="keyword">byte</span> [] message)</span> <span class="keyword">throws</span> InvalidProtocolBufferException </span>&#123;</span><br><span class="line">    AddressBook addressBook = AddressBook.parseFrom(message);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> addressBook;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>输出 AddressBook 对象</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">listAddressBook</span><span class="params">(AddressBook addressBook)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (Person person: addressBook.getPeoplesList()) &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"Person ID: "</span> + person.getId());</span><br><span class="line">        System.out.println(<span class="string">"  Name: "</span> + person.getName());</span><br><span class="line">        System.out.println(<span class="string">"  E-mail address: "</span> + person.getEmail());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Person.PhoneNumber phoneNumber : person.getPhonesList()) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (phoneNumber.getType()) &#123;</span><br><span class="line">                <span class="keyword">case</span> MOBILE:</span><br><span class="line">                    System.out.print(<span class="string">"  Mobile phone #: "</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> HOME:</span><br><span class="line">                    System.out.print(<span class="string">"  Home phone #: "</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> WORK:</span><br><span class="line">                    System.out.print(<span class="string">"  Work phone #: "</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(phoneNumber.getNumber());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>使用 ProtocolBuffer 序列化及反序列化数据</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InvalidProtocolBufferException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造 AddressBook 对象并序列化数据</span></span><br><span class="line">    <span class="keyword">byte</span> [] message = marshal();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 反序列化 AddressBook 对象</span></span><br><span class="line">    AddressBook addressBook = unmarshal(message);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出 AddressBook 对象</span></span><br><span class="line">    listAddressBook(addressBook);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>输出结果为：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Person ID: 1234</span><br><span class="line">  Name: John Doe</span><br><span class="line">  E-mail address: jdoe@example.com</span><br><span class="line">  Home phone <span class="comment">#: 555-4321</span></span><br></pre></td></tr></table></figure></p>
<h2 id="3-运行时模式"><a href="#3-运行时模式" class="headerlink" title="3. 运行时模式"></a>3. 运行时模式</h2><p>在该种方式下，不用定义 .proto 文件，引入 protostuff 工具包，然后使用其提供的 API 便可对 Java 对象进行 ProtocolBuffer 序列化/反序列化操作。</p>
<h3 id="3-1-引入-protostuff"><a href="#3-1-引入-protostuff" class="headerlink" title="3.1 引入 protostuff"></a>3.1 引入 protostuff</h3><p>在 maven pom 文件中加入如下依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- For the core formats (protostuff, protobuf, graph) --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.protostuff<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protostuff-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- For schemas generated at runtime --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.protostuff<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protostuff-runtime<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="3-2-定义-Java-Bean-对象"><a href="#3-2-定义-Java-Bean-对象" class="headerlink" title="3.2 定义 Java Bean 对象"></a>3.2 定义 Java Bean 对象</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="keyword">private</span> String mobile;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-3-定义工具类"><a href="#3-3-定义工具类" class="headerlink" title="3.3 定义工具类"></a>3.3 定义工具类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProtostuffUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 避免每次序列化都重新申请 Buffer 空间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> LinkedBuffer buffer = LinkedBuffer.allocate(LinkedBuffer.DEFAULT_BUFFER_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 缓存 Schema</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Class&lt;?&gt;, Schema&lt;?&gt;&gt; schemaCache = <span class="keyword">new</span> ConcurrentHashMap&lt;Class&lt;?&gt;, Schema&lt;?&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 序列化方法，把指定对象序列化成字节数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> obj 序列化的对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; 对象类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 字节数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">byte</span>[] serialize(T obj) &#123;</span><br><span class="line">        Class&lt;T&gt; clazz = (Class&lt;T&gt;) obj.getClass();</span><br><span class="line">        Schema&lt;T&gt; schema = getSchema(clazz);</span><br><span class="line">        <span class="keyword">byte</span>[] data;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            data = ProtostuffIOUtil.toByteArray(obj, schema, buffer);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            buffer.clear();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 反序列化方法，将字节数组反序列化成指定 Class 类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data 字节数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz 序列化对象的类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; 对象类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 反序列化后的对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] data, Class&lt;T&gt; clazz)</span> </span>&#123;</span><br><span class="line">        Schema&lt;T&gt; schema = getSchema(clazz);</span><br><span class="line">        T obj = schema.newMessage();</span><br><span class="line">        ProtostuffIOUtil.mergeFrom(data, obj, schema);</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Schema&lt;T&gt; <span class="title">getSchema</span><span class="params">(Class&lt;T&gt; clazz)</span> </span>&#123;</span><br><span class="line">        Schema&lt;T&gt; schema = (Schema&lt;T&gt;) schemaCache.get(clazz);</span><br><span class="line">        <span class="keyword">if</span> (schema == <span class="keyword">null</span>) &#123;</span><br><span class="line">            schema = RuntimeSchema.getSchema(clazz);</span><br><span class="line">            <span class="keyword">if</span> (schema == <span class="keyword">null</span>) &#123;</span><br><span class="line">                schemaCache.put(clazz, schema);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> schema;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-4-测试代码"><a href="#3-4-测试代码" class="headerlink" title="3.4 测试代码"></a>3.4 测试代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 构造 Person 对象</span></span><br><span class="line">    Person person = <span class="keyword">new</span> Person();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Person 对象赋值</span></span><br><span class="line">    person.setId(<span class="number">1</span>);</span><br><span class="line">    person.setName(<span class="string">"john"</span>);</span><br><span class="line">    person.setMobile(<span class="string">"13845678912"</span>);</span><br><span class="line">    person.setEmail(<span class="string">"john@gmail.com"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 序列化数据</span></span><br><span class="line">    <span class="keyword">byte</span> [] message = ProtostuffUtils.serialize(person);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 反序列化数据</span></span><br><span class="line">    Person john = ProtostuffUtils.deserialize(message, Person<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出 Person 对象数据</span></span><br><span class="line">    System.out.println(<span class="string">"person:\n"</span> + john);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果为：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">person:</span><br><span class="line">Person&#123;id=1, name=<span class="string">'john'</span>, email=<span class="string">'john@gmail.com'</span>, mobile=<span class="string">'13845678912'</span>&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>这两种方式不同的使用场景，如果后期不考虑代码的兼容问题，可以使用 protostuff 工具包，简单方便，如果代码迭代更新比较多，需要考虑不同版本的兼容问题，那最好定义合适的 .proto 文件来保证代码的兼容性。</p>
<p><br></p>
<p><strong>参考：</strong></p>
<hr>
<p><a href="https://developers.google.com/protocol-buffers/docs/javatutorial?hl=zh-CN" target="_blank" rel="noopener">1. Protocol Buffer Basics: Java</a></p>
<p><a href="https://github.com/protocolbuffers/protobuf/releases/tag/v3.18.1" target="_blank" rel="noopener">2. Protocol Buffers v3.18.1</a></p>
<p><a href="https://github.com/protostuff/protostuff" target="_blank" rel="noopener">3. github:protostuff</a></p>
<p><a href="https://github.com/protocolbuffers/protobuf" target="_blank" rel="noopener">4. github:protobuf</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/78781763" target="_blank" rel="noopener">5. java序列化机制之protoStuff</a></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/10/16/alligator-mq-rpc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Noahsark">
      <meta itemprop="description" content="不畏将来，不念过往">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以太格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2021/10/16/alligator-mq-rpc/" class="post-title-link" itemprop="http://yoursite.com/index.html">Alligator 系列：MQ RPC</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2021-10-16 10:59:56" itemprop="dateCreated datePublished" datetime="2021-10-16T10:59:56+08:00">2021-10-16</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2021-10-17 12:06:04" itemprop="dateModified" datetime="2021-10-17T12:06:04+08:00">2021-10-17</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Alligator网关/" itemprop="url" rel="index"><span itemprop="name">Alligator网关</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">1.8k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">2 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-概览"><a href="#1-概览" class="headerlink" title="1. 概览"></a>1. 概览</h2><p>在 Alligator 系统中，网关与业务系统之间是通过 MQ 进行通信。为了简化开发成本，基于 MQ, 实现了一套 RPC 调用，其封装了超时、同步调用及异步调用等功能，调用模型如下图所示：<br><img src="/images/alligator/mq-rpc-model.jpg" alt="mq-rpc-model" title="mq-rpc-model"></p>
<ul>
<li>使用两个 MQ 队列来存储信息，分别是请求及响应信息；</li>
<li>在请求端维护一个 request id,在响应信息中带上 request id,从而将请求与响应对应起来；</li>
<li>在请求端为每一个请求设置一个超时任务，避免长时间未响应结果。</li>
</ul>
<h2 id="2-数据结构"><a href="#2-数据结构" class="headerlink" title="2. 数据结构"></a>2. 数据结构</h2><p>在 MQ RPC 中，有几个关键的接口：1) MqProxy; 2) Topic; 3) Message; 4) PromisHolder; 5) ChannelHolder; 6) Consumer; 7) Producer; 除此之外，还有一个 RpcPromise, 它继承了 Netty 中的 DefaultPromise 类，实现异步转同步的功能。其类图如下所示：</p>
<p><img src="/images/alligator/mq-rpc-class.jpg" alt="mq-rpc" title="mq-rpc"></p>
<ol>
<li>MqProxy: MQ RPC 中的核心类，封装了 MQ 调用的实现，不同类型的 MQ 实现该接口即可。外部模块通过该类进行 RPC 的调用及响应结果的处理；</li>
<li>Topic：MQ 队列的抽象，在不同 MQ 中含义可能不同，在 RoketMQ, Kafka 中，该 Topic 对应的就是 MQ 中的 Topic, 而在 RabbitMQ 中，Topic 对应的则是一个队列；</li>
<li>Message：MQ 中传输的数据；</li>
<li>RpcPromise：代表了一次 RPC 调用，RPC 的结果就是通过 RpcPromise 通知给上层使用，一般是通过定义回调方法实现，另外调用超时的处理也是在 RpcPromise 中实现；</li>
<li>PromisHolder：RpcPromise 容器类，负责管理维护所有的 RpcPromise，其中包括生成 request id，删除 RpcPromise等等。PromisHolder 主要由 RPC 的调用方（客户端）维护。在 MQ 的实现中，request id 是全局惟一的，而在 TCP/Websocket 中，request id 只需要保证在一个 Connnection(一个客户端连接一个服务器称为一个 Connection) 惟一即可。说明：RPC 在 Alligator 中有两类实现，一类是基于 TCP/Websocket的，后续文章再讲述，一类是基于 MQ 的，即本文讲述的内容； </li>
<li>ChannelHolder：一次 RPC 调用在服务器端的会话（Session）信息，它维护了一次 RPC 的相关状态数据，如客户端信息，以便写入响应数据； </li>
<li>Consumer：用于订阅 MQ 中请求队列及响应队列的中的数据；</li>
<li>Producer：用于向 MQ 中发送数据；</li>
<li>MqProxyFactory：MqProxy 工厂类，用于实例化 MqProxy 类。</li>
</ol>
<h2 id="3-结论"><a href="#3-结论" class="headerlink" title="3. 结论"></a>3. 结论</h2><p>目前为止，对相关的抽象还不够完善，Message 及 Topic 只定义了空接口，后续可以提取公共的方法丰富其接口定义。</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/10/02/alligator-rocketmq-deploy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Noahsark">
      <meta itemprop="description" content="不畏将来，不念过往">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以太格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2021/10/02/alligator-rocketmq-deploy/" class="post-title-link" itemprop="http://yoursite.com/index.html">Alligator 系列：RocketMQ 基础知识及部署</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2021-10-02 11:40:18 / 修改时间：21:10:32" itemprop="dateCreated datePublished" datetime="2021-10-02T11:40:18+08:00">2021-10-02</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Alligator网关/" itemprop="url" rel="index"><span itemprop="name">Alligator网关</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">13k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">12 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h2><h3 id="1-1-概念模型"><a href="#1-1-概念模型" class="headerlink" title="1.1 概念模型"></a>1.1 概念模型</h3><p>RocketMQ 是阿里推出的一款消息系统，用来取代 Kafka 及 RabbitMQ. 在 Alligator 中支持使用 RocketMQ, 其概念模型如下所示：</p>
<p><img src="/images/alligator/rocketmq-conceptual-model.jpg" alt="rocketmq-conceptual-model" title="rocketmq-conceptual-model"></p>
<p>在上图中有几个关键的概念，Producer 是消息的发布者，Consumer 是消息的接收者，负责消费消息，ConsumerGroup 是同一类 Consumer 的集合，Topic 是消息的集合体，而 messageQueue 则是对 Topic 进行分区，来提高消息处理的并行度，从而提高系统的吞吐量。topic 中的 MessageQueue 由 ConsumerGroup 下的 Consumer 负责消费，根据不同的消费模式，保证消息都能被 consumer 进行消费。</p>
<h3 id="1-2-实现架构"><a href="#1-2-实现架构" class="headerlink" title="1.2 实现架构"></a>1.2 实现架构</h3><p>RocketMQ 实现架构如下图所示：<br><img src="/images/alligator/rocketmq_architecture.png" alt="rocketmq_architecture" title="rocketmq_architecture"><br>RocketMQ架构上主要分为四部分：</p>
<ul>
<li>Producer：消息发布者；</li>
<li>Consumer：消息消费者，支持 push 和 pull 两种消费方式。；</li>
<li>NameServer：注册中心，主要包括两个功能：1)Broker管理，实现 Broker 的注册及动态发现；2）路由信息管理，保存集群的整个路由信息。</li>
<li>BrokerServer：负责消息的存储、投递和查询以及服务高可用保证。</li>
</ul>
<font color="red"><strong> 说明: </strong></font><br><font color="red">NameServer 是无状态的，彼此之间互不通信，BrokerServer 要向所有的 NameServer 上报状态，而不是其中一台（NameServer 之间没有数据同步）。</font>

<p>RocketMQ 相关概念，来自官方网站：</p>
<blockquote>
<ol>
<li><strong>消息模型（Message Model）</strong><br>RocketMQ主要由 Producer、Broker、Consumer 三部分组成，其中Producer 负责生产消息，Consumer 负责消费消息，Broker 负责存储消息。Broker 在实际部署过程中对应一台服务器，每个 Broker 可以存储多个Topic的消息，每个Topic的消息也可以分片存储于不同的 Broker。Message Queue 用于存储消息的物理地址，每个Topic中的消息地址存储于多个 Message Queue 中。ConsumerGroup 由多个Consumer 实例构成。</li>
<li><strong>消息生产者（Producer）</strong><br>负责生产消息，一般由业务系统负责生产消息。一个消息生产者会把业务应用系统里产生的消息发送到broker服务器。RocketMQ提供多种发送方式，同步发送、异步发送、顺序发送、单向发送。同步和异步方式均需要Broker返回确认信息，单向发送不需要。</li>
<li><strong>消息消费者（Consumer）</strong><br>负责消费消息，一般是后台系统负责异步消费。一个消息消费者会从Broker服务器拉取消息、并将其提供给应用程序。从用户应用的角度而言提供了两种消费形式：拉取式消费、推动式消费。</li>
<li><strong>主题（Topic）</strong><br>表示一类消息的集合，每个主题包含若干条消息，每条消息只能属于一个主题，是RocketMQ进行消息订阅的基本单位。</li>
<li><strong>代理服务器（Broker Server）</strong><br>消息中转角色，负责存储消息、转发消息。代理服务器在RocketMQ系统中负责接收从生产者发送来的消息并存储、同时为消费者的拉取请求作准备。代理服务器也存储消息相关的元数据，包括消费者组、消费进度偏移和主题和队列消息等。</li>
<li><strong>名字服务（Name Server）</strong><br>名称服务充当路由消息的提供者。生产者或消费者能够通过名字服务查找各主题相应的Broker IP列表。多个Namesrv实例组成集群，但相互独立，没有信息交换。</li>
<li><strong>拉取式消费（Pull Consumer）</strong><br>Consumer消费的一种类型，应用通常主动调用Consumer的拉消息方法从Broker服务器拉消息、主动权由应用控制。一旦获取了批量消息，应用就会启动消费过程。</li>
<li><strong>推动式消费（Push Consumer）</strong><br>Consumer消费的一种类型，该模式下Broker收到数据后会主动推送给消费端，该消费模式一般实时性较高。</li>
<li><strong>生产者组（Producer Group）</strong><br>同一类Producer的集合，这类Producer发送同一类消息且发送逻辑一致。如果发送的是事务消息且原始生产者在发送之后崩溃，则Broker服务器会联系同一生产者组的其他生产者实例以提交或回溯消费。</li>
<li><strong>消费者组（Consumer Group）</strong><br>同一类Consumer的集合，这类Consumer通常消费同一类消息且消费逻辑一致。消费者组使得在消息消费方面，实现负载均衡和容错的目标变得非常容易。要注意的是，消费者组的消费者实例必须订阅完全相同的Topic。RocketMQ 支持两种消息模式：集群消费（Clustering）和广播消费（Broadcasting）。</li>
<li><strong>集群消费（Clustering）</strong><br>集群消费模式下,相同Consumer Group的每个Consumer实例平均分摊消息。</li>
<li><strong>广播消费（Broadcasting）</strong><br>广播消费模式下，相同Consumer Group的每个Consumer实例都接收全量的消息。</li>
<li><strong>普通顺序消息（Normal Ordered Message）</strong><br>普通顺序消费模式下，消费者通过同一个消息队列（ Topic 分区，称作 Message Queue） 收到的消息是有顺序的，不同消息队列收到的消息则可能是无顺序的。</li>
<li><strong>严格顺序消息（Strictly Ordered Message）</strong><br>严格顺序消息模式下，消费者收到的所有消息均是有顺序的。</li>
<li><strong>消息（Message）</strong><br>消息系统所传输信息的物理载体，生产和消费数据的最小单位，每条消息必须属于一个主题。RocketMQ中每个消息拥有唯一的Message ID，且可以携带具有业务标识的Key。系统提供了通过Message ID和Key查询消息的功能。</li>
<li><strong>标签（Tag）</strong><br>为消息设置的标志，用于同一主题下区分不同类型的消息。来自同一业务单元的消息，可以根据不同业务目的在同一主题下设置不同标签。标签能够有效地保持代码的清晰度和连贯性，并优化RocketMQ提供的查询系统。消费者可以根据Tag实现对不同子主题的不同消费逻辑，实现更好的扩展性。</li>
</ol>
</blockquote>
<h2 id="2-基础"><a href="#2-基础" class="headerlink" title="2. 基础"></a>2. 基础</h2><h3 id="2-1-消息存储"><a href="#2-1-消息存储" class="headerlink" title="2.1 消息存储"></a>2.1 消息存储</h3><p>消息存储是 RocketMQ 中最为复杂和最为重要的一部分，我们主要是从概念上对其理解，其实现不作过多分析，其存储整体结构如下所示：<br><img src="/images/alligator/rocketmq_message_storage.png" alt="rocketmq_message_storage" title="rocketmq_message_storage"></p>
<p>消息存储架构图中主要有下面三个跟消息存储相关的文件构成。</p>
<ol>
<li><p>CommitLog：存储消息及元数据信息，由 Producer 写入, 消息内容不是定长的。单个文件大小默认 1G, 文件名长度为 20 位，左边补零，剩余为起始偏移量，比如 00000000000000000000 代表了第一个文件，起始偏移量为 0，文件大小为 1G=1073741824；当第一个文件写满了，第二个文件为 00000000001073741824 ，起始偏移量为 1073741824 ，以此类推。消息主要是顺序写入日志文件，当文件满了，写入下一个文件；</p>
</li>
<li><p>ConsumeQueue：消息消费队列，等同于概念模型中的 MessageQueue，Consumer 根据 ConsumeQueue 来查找待消费的消息。其中，ConsumeQueue（逻辑消费队列）作为消费消息的索引，保存了指定 Topic 下的队列消息在 CommitLog 中的起始物理偏移量 offset，消息大小 size 和消息Tag 的 HashCode 值。consumequeue 文件可以看成是基于 topic 的 commitlog 索引文件，故 consumequeue 文件夹的组织方式如下：topic/queue/file 三层组织结构，具体存储路径为：$HOME/store/consumequeue/{topic}/{queueId}/{fileName}。同样 consumequeue 文件采取定长设计，每一个条目共 20 个字节，分别为 8 字节的 commitlog 物理偏移量、4 字节的消息长度、8 字节 tag hashcode，单个文件由 30W 个条目组成，可以像数组一样随机访问每一个条目，每个 ConsumeQueue 文件大小约 5.72M；</p>
</li>
<li><p>IndexFile：IndexFile（索引文件）提供了一种可以通过 key 或时间区间来查询消息的方法。Index 文件的存储位置是：$HOME \store\index${fileName}，文件名 fileName 是以创建时的时间戳命名的，固定的单个IndexFile 文件大小约为 400M，一个 IndexFile 可以保存 2000W 个索引，IndexFile 的底层存储设计为在文件系统中实现 HashMap 结构，故 RocketMQ 的索引文件其底层实现为 hash 索引。</p>
</li>
</ol>
<p>从 RocketMQ 的消息存储整体架构图中可以看出，RocketMQ 采用的是混合型的存储结构，即为 Broker 单个实例下所有的队列共用一个日志数据文件（即为CommitLog）来存储。多个Topic的消息实体内容都存储于一个CommitLog中，Producer 发送消息到 Broker 端，然后 Broker 端使用同步或者异步的方式对消息刷盘持久化，保存至 CommitLog 中。只要消息被刷盘持久化至磁盘文件 CommitLog 中，那 么Producer 发送的消息就不会丢失。</p>
<h3 id="2-2-消息过滤"><a href="#2-2-消息过滤" class="headerlink" title="2.2 消息过滤"></a>2.2 消息过滤</h3><p>消息过滤是订阅/消费消息的时候处理的，Consumer 先从 ConsumeQueue 中拿到消息的索引，再去 CommitLog 中取到数据，过滤的操作就是根据索引来进行的，我们先看下 ConsumeQueue 中消息索引的格式：</p>
<p><img src="/images/alligator/rocketmq_message_index.png" alt="rocketmq_message_index" title="rocketmq_message_index"></p>
<p>可以看到其中有 8 个字节存储的 Message Tag 的哈希值，基于 Tag 的消息过滤正是基于这个字段值的。RocketMQ 支持两种过滤方式，1）Tag 过滤，Consumer 在订阅消息时除了指定 Topic 还可以指定 Tag，如果一个消息有多个 Tage ，可以用||分隔。从 ConsumeQueue 读取到记录后，会根据 tag hash 值去做过滤，由于使用 hashcode 进行判断，只能进行整体过滤，无法精确对 tag 原始字符串进行过滤，所以 Cousumer 接收到消息之后，还需要对消息的原始 tag 字符串进行比对，如果不同，则丢弃该消息，不进行消息消费。2） SQL92 过滤，使用 SQL 表达式进行过滤。</p>
<h3 id="2-3-消息负载均衡"><a href="#2-3-消息负载均衡" class="headerlink" title="2.3 消息负载均衡"></a>2.3 消息负载均衡</h3><p>RocketMQ 中的负载均衡都在 Client 端完成，具体来说的话，主要可以分为 Producer 端发送消息时候的负载均衡和 Consumer 端订阅消息的负载均衡。</p>
<p><strong>Producer 端负载均衡</strong><br>Producer 端在发送消息的时候，会找到 Topic 相关的所有 MessageQueue 信息，根据一定的负载策略选择一个 MessageQueue 进行发送。</p>
<p><strong>Consumer 端负载均衡</strong><br>Consumer 端负载均衡的主要目的是将 Topic 下的 MessageQueue 分配给 CousumerGroup 中的 Consumer，并保证一个 MessageQueue 只能被一个 Consumer 消费（集群模式下）。</p>
<p><img src="/images/alligator/rocketmq_message_allocate.png" alt="rocketmq_message_allocate" title="rocketmq_message_allocate"></p>
<h2 id="3-部署"><a href="#3-部署" class="headerlink" title="3. 部署"></a>3. 部署</h2><h3 id="3-1-单机部署"><a href="#3-1-单机部署" class="headerlink" title="3.1 单机部署"></a>3.1 单机部署</h3><p>由于只是用于实验目的，只需要部署单 Master 模式。</p>
<p><strong>官方推荐配置</strong></p>
<ol>
<li>64bit OS, Linux/Unix/Mac is recommended;(Windows user see guide below)</li>
<li>64bit JDK 1.8+;</li>
<li>Maven 3.2.x;</li>
<li>Git;</li>
<li>4g+ free disk for Broker server</li>
</ol>
<p>下载 RocketMQ V4.8.0，并解压到安装目录<br><a href="https://www.apache.org/dyn/closer.cgi?path=rocketmq/4.8.0/rocketmq-all-4.8.0-source-release.zip" target="_blank" rel="noopener">https://www.apache.org/dyn/closer.cgi?path=rocketmq/4.8.0/rocketmq-all-4.8.0-source-release.zip</a></p>
<p><strong>修改配置</strong><br><strong>1. 修改 rocketmq-4.8.0/conf/broker.conf</strong><br>如果部署在公有云上，需要将 brokerIP 和 namesrvAddr 设置为公网 ip 地址和端口<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">brokerClusterName = DefaultCluster</span><br><span class="line">brokerName = broker<span class="_">-a</span></span><br><span class="line">brokerId = 0</span><br><span class="line">deleteWhen = 04</span><br><span class="line">fileReservedTime = 48</span><br><span class="line">brokerRole = ASYNC_MASTER</span><br><span class="line">flushDiskType = ASYNC_FLUSH</span><br><span class="line"><span class="comment">## broker ip</span></span><br><span class="line">brokerIP1=公网ip </span><br><span class="line"></span><br><span class="line"><span class="comment">## na</span></span><br><span class="line">namesrvAddr=公网ip:9876</span><br></pre></td></tr></table></figure></p>
<p><strong>2. 修改内存大小</strong><br>RocketMQ 默认内存配置是 4G, 单机版本配置启动 1台 nameServer 及 1台 broker, 如果配置不够的话，需要修改 runbroker.sh 和 runserver.sh 脚本。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JAVA_OPT=<span class="string">"<span class="variable">$&#123;JAVA_OPT&#125;</span> -server -Xms2g -Xmx2g -Xmn1g"</span></span><br></pre></td></tr></table></figure></p>
<p>根据情况修改，这里修改为 2G.</p>
<h3 id="3-2-命令"><a href="#3-2-命令" class="headerlink" title="3.2 命令"></a>3.2 命令</h3><p><strong>1. 启动 nameServer</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> rocketmq-4.8.0/bin</span><br><span class="line"></span><br><span class="line">nohup sh mqnamesrv -n 外网ip:9876 &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># -n: 指定nameserv ip 地址</span></span><br></pre></td></tr></table></figure></p>
<p><strong>2. 启动 broker</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> rocketmq-4.8.0</span><br><span class="line"></span><br><span class="line">nohup sh bin/mqbroker -n 外网ip:9876 -c conf/broker.conf &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># -n: 指定nameserv ip 地址</span></span><br><span class="line"><span class="comment"># -c: 指定配置文件</span></span><br></pre></td></tr></table></figure></p>
<p><strong>3. 关闭服务器</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭 broker</span></span><br><span class="line">./mqshutdown broker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭 namesrv</span></span><br><span class="line">./mqshutdown namesrv</span><br></pre></td></tr></table></figure></p>
<p><strong>4. Topic 命令</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 topic</span></span><br><span class="line">sh mqadmin updateTopic -n 外网ip:9876 -c DefaultCluster -t &lt;topic name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询 topic</span></span><br><span class="line">sh mqadmin topicList –n 外网ip:9876</span><br></pre></td></tr></table></figure></p>
<font color="red"><strong> 说明: </strong></font><br><font color="red">在 RocketMQ 中，Topic 须提前创建。</font>

<p><br></p>
<p><strong>参考：</strong></p>
<hr>
<p><a href="https://github.com/apache/rocketmq/blob/master/docs/cn/concept.md" target="_blank" rel="noopener">1. RocketMQ 基本概念</a></p>
<p><a href="https://github.com/apache/rocketmq/blob/master/docs/cn/architecture.md" target="_blank" rel="noopener">2. RocketMQ 架构设计</a></p>
<p><a href="https://github.com/apache/rocketmq/blob/master/docs/cn/design.md" target="_blank" rel="noopener">3. RocketMQ 设计(design)</a></p>
<p><a href="https://mp.weixin.qq.com/s/Efw5pXrptWPfCDQI8rc_xg" target="_blank" rel="noopener">4. 一文讲透Apache RocketMQ技术精华</a></p>
<p><a href="http://rocketmq.apache.org/docs/quick-start/" target="_blank" rel="noopener">5. RocketMQ Quick Start</a></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/30/alligator-rabbitmq-deploy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Noahsark">
      <meta itemprop="description" content="不畏将来，不念过往">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以太格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2021/09/30/alligator-rabbitmq-deploy/" class="post-title-link" itemprop="http://yoursite.com/index.html">Alligator 系列：RabbitMQ 基础知识及部署</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2021-09-30 09:12:20" itemprop="dateCreated datePublished" datetime="2021-09-30T09:12:20+08:00">2021-09-30</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2021-10-16 10:49:31" itemprop="dateModified" datetime="2021-10-16T10:49:31+08:00">2021-10-16</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Alligator网关/" itemprop="url" rel="index"><span itemprop="name">Alligator网关</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">25k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">22 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-概览"><a href="#1-概览" class="headerlink" title="1. 概览"></a>1. 概览</h2><p>RabbitMQ 是一种消息系统，相比较其它消息系统，除了 queue，它多了一个 exchange 交换器的概念，在 Alligator 中支持使用 RabbitMQ, 其整体结构如下图所示：<br><img src="/images/alligator/rabbitmq-overview.png" alt="rabbitmq-overview" title="rabbitmq-overview"></p>
<p>现在假设有这样一个业务场景，一个 web app 具备生成 PDF 文档的能力，而生成 PDF 文档是一个耗时的操作，需要交给后台的 PDF 任务去执行。为了提高系统的吞吐量，引入 RabbitMQ 缓存请求，其流程为：</p>
<ol>
<li>用户发送一个生成 PDF 的请求给 web app;</li>
<li>Web app (Producer) 发送一个消息给 RabbitMQ;</li>
<li>Exchange 收到消息并路由消息到合适的 Queue; </li>
<li>PDF 任务(Consumer) 接收来自 Queue 的消息，生成 PDF.</li>
</ol>
<p>消息不是直接发送到 Queue 中，而是发送到 Exchange 中，最后通过 routing Key 在 Exchange 和 Queue 中建立一个 binding 关系，从而将消息路由到不同的 Queue 中。</p>
<p><img src="/images/alligator/exchanges-bidings-routing-keys.png" alt="exchanges-bidings-routing-keys" title="exchanges-bidings-routing-keys"></p>
<p>RabbitMQ 中消息处理流程：</p>
<ol>
<li>Producer 发布一个消息到 Exchange 中，在创建 Exchange 时必须指定其类型；</li>
<li>Exchange 收到消息并负责消息的路由，Exchange 会根据消息的属性进行路由，其中，routing key 是一个关键的属性，根据 Exchange 类型，可以有不同的路由策略；</li>
<li>Bindings(绑定关系) 必须创建，它决定了消息从 Exchange 路由到哪个 Queue，在这个 case 中，有两个绑定关系，路由到那个 Queue，取决于消息的属性；</li>
<li>消息路由到 Queue 中，并等待 Consumer 处理；</li>
<li>Consumer 接收消息并处理。</li>
</ol>
<p>Exchange 有四种类型：direct, topic, headers 和 fanout.<br><img src="/images/alligator/exchanges-topic-fanout-direct.png" alt="exchanges-topic-fanout-direct" title="exchanges-topic-fanout-direct"></p>
<ol>
<li>Direct: Binding Key 与 Routing Key 精确匹配。binding key 是 exchange 与 queue 建立绑定关系指定的属性，而 routing key 则是由 Producer 发送消息是指定的属性，如果两个 key 相同，消息则路由到与 binding key 相关联的 queue 中；</li>
<li>Fanout: 广播所有的消息；</li>
<li>Topic: 是比较灵活的类型，可以在 binding key 中指定通配符(*,#)，如 eu.fe.*, us.#, 其中，* 表示匹配一个单词，# 表示匹配多个单词。通过通配符，可以实现层次结构的匹配；</li>
<li>Headers: Headers exchanges 使用消息的属性进行路由。</li>
</ol>
<p><strong>Binding Key 与 Routing Key：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// exchange 申明, 可以指定 type</span></span><br><span class="line">AMQP.Exchange.DeclareOk exchangeDeclare​(String exchange, String type, <span class="keyword">boolean</span> durable) <span class="keyword">throws</span> IOException</span><br><span class="line"></span><br><span class="line"><span class="comment">// 建立绑定关系，指定 bindingKey</span></span><br><span class="line">AMQP.Queue.BindOk queueBind​(String queue, String exchange, String bindingKey, Map&lt;String,​Object&gt; arguments) <span class="keyword">throws</span> IOException</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发布消息，指定 routingKey</span></span><br><span class="line"><span class="keyword">void</span> basicPublish​(String exchange, String routingKey, <span class="keyword">boolean</span> mandatory, AMQP.BasicProperties props, <span class="keyword">byte</span>[] body) <span class="keyword">throws</span> IOException</span><br></pre></td></tr></table></figure></p>
<p>通过 routingKey 与 bindingKey 进行匹配，从而实现消息的路由。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@my-rabbit:/<span class="comment"># rabbitmqctl list_exchanges</span></span><br><span class="line">Listing exchanges <span class="keyword">for</span> vhost / ...</span><br><span class="line">name    <span class="built_in">type</span></span><br><span class="line">amq.topic       topic</span><br><span class="line">amq.fanout      fanout</span><br><span class="line">amq.direct      direct</span><br><span class="line">amq.headers     headers</span><br><span class="line">amq.match       headers</span><br><span class="line">                direct(default)</span><br><span class="line">amq.rabbitmq.trace      topic</span><br></pre></td></tr></table></figure>
<p>通过 rabbitmqctl 命令可以查看 exchange 信息，在这个列表中，一些是 amq.* 打头的 exchange, 还一个没有命名，空名字的 exchange, 这个空的 exchange 是默认的 exchange. 它们都是默认创建好的。</p>
<p>在发布消息的时候，可以不指定 exchange 的名称, 如下代码所示：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">channel.basic_publish(exchange=<span class="string">''</span>,</span><br><span class="line">                      routing_key=<span class="string">'task_queue'</span>,</span><br><span class="line">                      body=message)</span><br></pre></td></tr></table></figure></p>
<p>空的 exchange 代表了默认或无名的 exchange: 消息会路由到与 routing_key 同名的 queue 中，在这个 case 中，消息最终路由到 task_queue queue 中。</p>
<h2 id="2-基础知识"><a href="#2-基础知识" class="headerlink" title="2. 基础知识"></a>2. 基础知识</h2><h3 id="2-1-Consumer-ACK-机制"><a href="#2-1-Consumer-ACK-机制" class="headerlink" title="2.1 Consumer ACK 机制"></a>2.1 Consumer ACK 机制</h3><p>Consumer ACK 有两种模式：1）自动；2）手动。在自动模式下，Broker 分发消息之后即认为分发成功，便可删除消息，该模式被认为是不安全的。而自动模式需要程序手动发送 Ack 确认信息，这样可以保证消息被处理。</p>
<p>官方文档对自动模式描述如下：</p>
<blockquote>
<p>In automatic acknowledgement mode, a message is considered to be successfully delivered immediately after it is sent. This mode trades off higher throughput (as long as the consumers can keep up) for reduced safety of delivery and consumer processing. This mode is often referred to as “fire-and-forget”. Unlike with manual acknowledgement model, if consumers’s TCP connection or channel is closed before successful delivery, the message sent by the server will be lost. Therefore, automatic message acknowledgement should be considered unsafe and not suitable for all workloads.</p>
</blockquote>
<p>通过下面方法来设置自动或手动：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> autoAck = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">channel.basicConsume(queueName, autoAck, <span class="string">"a-consumer-tag"</span>,</span><br><span class="line">     <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    Envelope envelope,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    AMQP.BasicProperties properties,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">byte</span>[] body)</span></span></span><br><span class="line"><span class="function">             <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function">         </span>&#123;</span><br><span class="line">             <span class="keyword">long</span> deliveryTag = envelope.getDeliveryTag();</span><br><span class="line">             <span class="comment">// negatively acknowledge, the message will</span></span><br><span class="line">             <span class="comment">// be discarded</span></span><br><span class="line">             channel.basicReject(deliveryTag, <span class="keyword">false</span>);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;);</span><br></pre></td></tr></table></figure></p>
<p>默认是自动模式，可以在 channel.basicConsume 方法中设置为 false。</p>
<p><strong>手动 Ack 有三个方法：</strong></p>
<ul>
<li>basic.ack : 用于肯定应答；</li>
<li>basic.nack ：用于否定应答，可以重新 requeue 排队发送；</li>
<li>basic.reject ：用于否定应答，与 nack 的区别在于是否支持批量确认。</li>
</ul>
<p><strong>basic.ack 方法定义：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> deliveryTag = envelope.getDeliveryTag();</span><br><span class="line"></span><br><span class="line">channel.basicAck(<span class="keyword">long</span> deliveryTag, <span class="keyword">boolean</span> multiple);</span><br></pre></td></tr></table></figure></p>
<p>其中，</p>
<ul>
<li>deliveryTag : 消息的唯一标示，在一个channel 中一个消息具有唯一的 deliveryTag；</li>
<li>multiple ：是否批量确认，true 表示 deliveryTag 之前的消息都被确认，false 只确认当前消息。</li>
</ul>
<p><strong>basic.nack 方法定义：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> deliveryTag = envelope.getDeliveryTag();</span><br><span class="line"></span><br><span class="line">channel.basicNack(<span class="keyword">long</span> deliveryTag, <span class="keyword">boolean</span> requeue, <span class="keyword">boolean</span> multiple);</span><br></pre></td></tr></table></figure></p>
<p>其中，</p>
<ul>
<li>deliveryTag : 消息的唯一标示，在一个channel 中一个消息具有唯一的 deliveryTag；</li>
<li>requeue : 是否重新排队发送，true 表示重新排队，false 表示删除该消息；</li>
<li>multiple ：是否批量确认，true 表示 deliveryTag 之前的消息都被确认，false 只确认当前消息。</li>
</ul>
<p><strong>basic.reject方法定义：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> deliveryTag = envelope.getDeliveryTag();</span><br><span class="line"></span><br><span class="line">basic.reject(<span class="keyword">long</span> deliveryTag, <span class="keyword">boolean</span> requeue);</span><br></pre></td></tr></table></figure></p>
<p>其中，</p>
<ul>
<li>deliveryTag : 消息的唯一标示，在一个channel 中一个消息具有唯一的 deliveryTag；</li>
<li>requeue : 是否重新排队发送，true 表示重新排队，false 表示删除该消息；</li>
</ul>
<h3 id="2-2-QoS"><a href="#2-2-QoS" class="headerlink" title="2.2 QoS"></a>2.2 QoS</h3><p>QoS 主要是为了控制向 Consumer 发送消息的频率，通过配置当前未确认的消息数量来控制是否发送，如 Qos = 5，则表示如果有 5 条消息未被确认，则不向 Consumer 发送消息。通过配置 QoS，可以避免消息在 Consumer 中堆积。正常情况下，QoS 是配合手动 Ack 一起使用的。<br>在生产环境中，需要根据压测结果选择合适的值进行配置，QoS = 0 表示不限制，QoS = 1 是保守的配置，为了提高系统的吞吐量，一般可以设置较大的值。QoS 可以配置在 Channel 或 Consumer 上，Channel 的配置如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.basicQos(<span class="number">1</span>);</span><br></pre></td></tr></table></figure></p>
<h3 id="2-3-Producer-Comfirm"><a href="#2-3-Producer-Comfirm" class="headerlink" title="2.3 Producer Comfirm"></a>2.3 Producer Comfirm</h3><p>Consumer 通过 Ack 机制保证消息被消费，同样，Producer 通过 Confirm 机制保证投递到 broker 中，可以通过下面的代码开启 Comfirm。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开启 confirm</span></span><br><span class="line">ch.confirmSelect();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 同步等待</span></span><br><span class="line">ch.waitForConfirmsOrDie(<span class="number">5_000</span>);</span><br></pre></td></tr></table></figure></p>
<p>可以结合业务，实现单个消息、批量消息的确认及消息的异步确认。</p>
<h3 id="2-4-持久化"><a href="#2-4-持久化" class="headerlink" title="2.4 持久化"></a>2.4 持久化</h3><p>消息的持久化，包括 exchange 及 queue 的持久化，其参数配置如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// exchange 申明</span></span><br><span class="line">channel.exchangeDeclare​(String exchange, String type, <span class="keyword">boolean</span> durable);</span><br><span class="line"></span><br><span class="line"><span class="comment">// queue 申明</span></span><br><span class="line">channel.queueDeclare​(String queue, <span class="keyword">boolean</span> durable, <span class="keyword">boolean</span> exclusive, <span class="keyword">boolean</span> autoDelete, Map&lt;String,​Object&gt; arguments);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 queue 绑定到 exchange 上</span></span><br><span class="line">channel.queueBind​(String queue, String exchange, String routingKey);</span><br></pre></td></tr></table></figure></p>
<p><strong>Exchange 申明：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AMQP.Exchange.DeclareOk exchangeDeclare​(String exchange, String type, <span class="keyword">boolean</span> durable) <span class="keyword">throws</span> IOException</span><br></pre></td></tr></table></figure></p>
<p>参数说明：</p>
<ul>
<li>exchange: exchange 名称</li>
<li>type: exchange type</li>
<li>durable: 是否持久化，若为 true，服务器重启之后，exchange 还会存在。</li>
</ul>
<p><strong>Queue​ 申明：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AMQP.Queue.DeclareOk queueDeclare​(String queue, <span class="keyword">boolean</span> durable, <span class="keyword">boolean</span> exclusive, <span class="keyword">boolean</span> autoDelete, Map&lt;String,​Object&gt; arguments) <span class="keyword">throws</span> IOException</span><br></pre></td></tr></table></figure></p>
<p>参数说明：</p>
<ul>
<li>queue: queue 名称</li>
<li>durable: 是否持久化，若为 true，服务器重启后，queue 仍然存在</li>
<li>exclusive: 是否具有排他性，若为 true, 不允许其它客户端连接</li>
<li>autoDelete: 是否自动删除，若为 true, 队列没有使用时，则为自动删除</li>
<li>arguments: 其它参数</li>
</ul>
<p><strong>QueueBind​ 申明：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AMQP.Queue.BindOk queueBind​(String queue, String exchange, String routingKey, Map&lt;String,​Object&gt; arguments) <span class="keyword">throws</span> IOException</span><br></pre></td></tr></table></figure></p>
<p>参数说明：</p>
<ul>
<li>queue: queue 名称</li>
<li>exchange: exchange 名称</li>
<li>routingKey: 路由 key</li>
<li>arguments: 其它参数</li>
</ul>
<p><strong>basicPublish 申明：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> basicPublish​(String exchange, String routingKey, <span class="keyword">boolean</span> mandatory, AMQP.BasicProperties props, <span class="keyword">byte</span>[] body) <span class="keyword">throws</span> IOException</span><br></pre></td></tr></table></figure></p>
<p>参数说明：</p>
<ul>
<li>exchange: exchange 名称</li>
<li>routingKey: 路由 key</li>
<li>mandatory: 若为 tue,表示消息若不能路由，则将消息 return 给发送者，发送者可以定义重发逻辑，若为 false, 则将消息丢弃或发送给另外的 exchange</li>
<li>props: 参数，可以指定消息的类型或是否持久化</li>
<li>body: 消息内容</li>
</ul>
<p>示例：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">channel.basicPublish(exchangeName, routingKey, <span class="keyword">true</span>, MessageProperties.PERSISTENT_TEXT_PLAIN,</span><br><span class="line">                        body.getBytes(<span class="string">"UTF-8"</span>));</span><br></pre></td></tr></table></figure></p>
<font color="red"><strong> 说明: </strong></font><br><font color="red">在 RabbitMQ 中，exchange 及 queue 不用提前创建，调用上面的申明方法时，如果没有不存在，则会自动创建。</font>

<h3 id="2-5-Virtual-Hosts"><a href="#2-5-Virtual-Hosts" class="headerlink" title="2.5 Virtual Hosts"></a>2.5 Virtual Hosts</h3><blockquote>
<p>RabbitMQ is multi-tenant system: connections, exchanges, queues, bindings, user permissions, policies and some other things belong to virtual hosts, logical groups of entities</p>
</blockquote>
<p>RabbitMQ 是一个多租户系统，connections, exchanges, queues, bindings, user 权限, 策略及其它东西都属于一个 virtual host。使用 virtual host，需要用户提前创建，系统默认的 vhost 是 ‘/‘。</p>
<h2 id="3-部署"><a href="#3-部署" class="headerlink" title="3. 部署"></a>3. 部署</h2><font color="red"><strong> 说明: </strong></font><br><font color="red">只是用于实验目的，安装单机版本。</font>

<h3 id="3-1-安装-Rabbitmq"><a href="#3-1-安装-Rabbitmq" class="headerlink" title="3.1 安装 Rabbitmq"></a>3.1 安装 Rabbitmq</h3><p>使用 docker 部署单机版本，版本使用的是 3.9。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 安装 rabbitmq</span><br><span class="line">docker run -d --hostname my-rabbit --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3.9-management</span><br><span class="line"></span><br><span class="line">// 进入容器</span><br><span class="line">docker <span class="built_in">exec</span> -it 容器id bash</span><br></pre></td></tr></table></figure></p>
<h3 id="3-2-创建-virtual-host"><a href="#3-2-创建-virtual-host" class="headerlink" title="3.2 创建 virtual host"></a>3.2 创建 virtual host</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 创建 alligator vhost</span><br><span class="line">rabbitmqctl add_vhost &lt;vhost_name&gt;</span><br><span class="line"></span><br><span class="line">rabbitmqctl add_vhost alligator</span><br><span class="line"></span><br><span class="line">// 查看 vhost</span><br><span class="line">rabbitmqctl list_vhosts</span><br></pre></td></tr></table></figure>
<h3 id="3-3-创建用户"><a href="#3-3-创建用户" class="headerlink" title="3.3 创建用户"></a>3.3 创建用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// 创建 user</span><br><span class="line">rabbitmqctl add_user test_user 123456</span><br><span class="line"></span><br><span class="line">// 查看 user</span><br><span class="line">rabbitmqctl list_users</span><br><span class="line"></span><br><span class="line">// rabbitmqctl 用户相关的命令</span><br><span class="line">add_user &lt;username&gt; &lt;password&gt;</span><br><span class="line">delete_user &lt;username&gt;</span><br><span class="line">change_password &lt;username&gt; &lt;newpassword&gt;</span><br><span class="line">clear_password &lt;username&gt;</span><br><span class="line">authenticate_user &lt;username&gt; &lt;password&gt;</span><br><span class="line">set_user_tags &lt;username&gt; &lt;tag&gt; ...</span><br><span class="line">list_users</span><br></pre></td></tr></table></figure>
<p>rabbitmq 角色有：none,management,policymaker,monitoring 及 administrator，可以通过下面的命令设置角色。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 设置角色</span><br><span class="line">rabbitmqctl set_user_tags &lt;user&gt; &lt;role&gt;</span><br><span class="line"></span><br><span class="line">// 设置为超级管理员</span><br><span class="line">rabbitmqctl set_user_tags test_user administrator</span><br></pre></td></tr></table></figure>
<h3 id="3-4-授权用户"><a href="#3-4-授权用户" class="headerlink" title="3.4 授权用户"></a>3.4 授权用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 授权用户</span><br><span class="line">rabbitmqctl set_permissions [-p &lt;vhost&gt;] &lt;user&gt; &lt;conf&gt; &lt;write&gt; &lt;<span class="built_in">read</span>&gt;</span><br><span class="line"></span><br><span class="line">// 授权 test_user 具备 alligator vhost 下所有资源的读写权限</span><br><span class="line">rabbitmqctl set_permissions -p alligator  allen <span class="string">'.*'</span> <span class="string">'.*'</span> <span class="string">'.*'</span></span><br></pre></td></tr></table></figure>
<h3 id="3-5-管理后台"><a href="#3-5-管理后台" class="headerlink" title="3.5 管理后台"></a>3.5 管理后台</h3><p>RabbitMQ 默认创建了 guest(密码为 guest)，处于安全考虑，建议删除该用户，新建一个自定义用户，用于后台的管理。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 删除 guest 用户</span><br><span class="line">rabbitmqctl delete_user guest</span><br><span class="line"></span><br><span class="line">// 新建 admin 用户</span><br><span class="line">rabbitmqctl add_user admin ********</span><br><span class="line"></span><br><span class="line">// 设置 admin 为 administrator 角色</span><br><span class="line">rabbitmqctl set_user_tags admin administrator</span><br><span class="line"></span><br><span class="line">// 将 / (vhost) 所有权限授权给 admin</span><br><span class="line">rabbitmqctl set_permissions -p / admin <span class="string">'.*'</span> <span class="string">'.*'</span> <span class="string">'.*'</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><strong>参考：</strong></p>
<hr>
<p><a href="https://www.cloudamqp.com/blog/part1-rabbitmq-for-beginners-what-is-rabbitmq.html" target="_blank" rel="noopener">1. part 1: RabbitMQ for beginners - What is RabbitMQ?</a></p>
<p><a href="https://rabbitmq.github.io/rabbitmq-java-client/api/4.x.x/com/rabbitmq/client/Channel.html" target="_blank" rel="noopener">2. rabbitmq api doc</a></p>
<p><a href="https://www.rabbitmq.com/confirms.html" target="_blank" rel="noopener">3. Consumer Acknowledgements and Publisher Confirms</a></p>
<p><a href="https://www.rabbitmq.com/vhosts.html" target="_blank" rel="noopener">4. Virtual Hosts</a></p>
<p><a href="https://www.rabbitmq.com/queues.html" target="_blank" rel="noopener">5. queues</a></p>
<p><a href="https://www.rabbitmq.com/getstarted.html" target="_blank" rel="noopener">6. RabbitMQ Tutorials</a></p>
<p><a href="https://www.rabbitmq.com/access-control.html" target="_blank" rel="noopener">7. Authentication, Authorisation, Access Control</a></p>
<p><a href="https://www.rabbitmq.com/rabbitmqctl.8.html" target="_blank" rel="noopener">8. rabbitmqctl(8)</a></p>
<p><a href="https://www.rabbitmq.com/production-checklist.html" target="_blank" rel="noopener">9. Production Checklist</a></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Noahsark</p>
              <p class="site-description motion-element" itemprop="description">不畏将来，不念过往</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">50</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">21</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">164</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Noahsark</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="站点总字数">197k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="站点阅读时长">2:59</span>
  
</div>

<div class="BbeiAn-info">
    <a target="_blank" href="https://beian.miit.gov.cn/" rel="nofollow">粤ICP备 2021097726号-1 </a>
	<a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44030702004132" style="text-decoration:none;padding-left:30px;background:url(https://s1.ax1x.com/2018/09/29/ilmwIH.png) no-repeat left center" rel="nofollow">粤公网安备 44030702004132号</a>
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v6.5.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.5.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.5.0"></script>



  



  










  





  

  

  

  

  

  
  

  

  

  

  

  

  

</body>
</html>
