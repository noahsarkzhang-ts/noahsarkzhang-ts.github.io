<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.5.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.5.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.5.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.5.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="概述RSocket 官网对 RSocket 定义：  RSocket is a binary protocol for use on byte stream transports such as TCP, WebSockets, and Aeron.RSocket provides a protocol for Reactive Streams semantics between client-s">
<meta name="keywords" content="rscocket">
<meta property="og:type" content="article">
<meta property="og:title" content="RPC：RScocket">
<meta property="og:url" content="http://yoursite.com/2021/11/21/rsocket-overview/index.html">
<meta property="og:site_name" content="以太格">
<meta property="og:description" content="概述RSocket 官网对 RSocket 定义：  RSocket is a binary protocol for use on byte stream transports such as TCP, WebSockets, and Aeron.RSocket provides a protocol for Reactive Streams semantics between client-s">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/images/rpc/flux.svg">
<meta property="og:image" content="http://yoursite.com/images/rpc/mono.svg">
<meta property="og:image" content="http://yoursite.com/images/rpc/rsocket-publisher-class.jpg">
<meta property="og:image" content="http://yoursite.com/images/rpc/rsocket-publisher.jpg">
<meta property="og:image" content="http://yoursite.com/images/rpc/rsocket-interaction-model.png">
<meta property="og:updated_time" content="2021-11-27T10:14:23.295Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RPC：RScocket">
<meta name="twitter:description" content="概述RSocket 官网对 RSocket 定义：  RSocket is a binary protocol for use on byte stream transports such as TCP, WebSockets, and Aeron.RSocket provides a protocol for Reactive Streams semantics between client-s">
<meta name="twitter:image" content="http://yoursite.com/images/rpc/flux.svg">






  <link rel="canonical" href="http://yoursite.com/2021/11/21/rsocket-overview/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>RPC：RScocket | 以太格</title>
  











  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">以太格</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-commonweal">

    
    
    
      
    

    

    <a href="/404/" rel="section"><i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br>公益 404</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于我</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/11/21/rsocket-overview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Noahsark">
      <meta itemprop="description" content="不畏将来，不念过往">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以太格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">RPC：RScocket
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2021-11-21 12:45:56" itemprop="dateCreated datePublished" datetime="2021-11-21T12:45:56+08:00">2021-11-21</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2021-11-27 18:14:23" itemprop="dateModified" datetime="2021-11-27T18:14:23+08:00">2021-11-27</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/RPC/" itemprop="url" rel="index"><span itemprop="name">RPC</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">71k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">1:05</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>RSocket 官网对 RSocket 定义：</p>
<blockquote>
<p>RSocket is a binary protocol for use on byte stream transports such as TCP, WebSockets, and Aeron.RSocket provides a protocol for Reactive Streams semantics between client-server, and server-server communication.</p>
</blockquote>
<p>RSocket 是一个构建在字节流传输协议，如 TCP, WebSocket 和 Aeron(UDP) 之上的二进制协议，同时，它也是一个为client-server,server-server 之间通信提供了反应式流语义的协议。本质上来说，RSocket 是基于反应式编程的一个二进制协议。一个反应式系统应该具备如下特征：</p>
<ul>
<li>Responsive: 只要有可能，系统就会及时地作出反应;</li>
<li>Resilient: 系统出现 failure 时仍然保持响应性，并能够独立恢复;</li>
<li>Elastic: 系统在不断变化的工作负载之下依然能保持即时响应性;</li>
<li>Message Driven: 异步非阻塞消息驱动架构。</li>
</ul>
<p>RSocket 作为一个应用层的协议，提供了丰富的功能：</p>
<ul>
<li>Multiplexed, Binary Protocol：多路复用的二进制协议；</li>
<li>Bidirectional Streaming: 双向流；</li>
<li>Flow Control: 流控制；</li>
<li>Socket Resumption: 连接恢复；</li>
<li>Message passing: 消息传递模型；</li>
<li>Transport independent: 与传输层解耦的应用层协议。</li>
</ul>
<p>在这篇文章，主要讲述与流相关的功能。</p>
<h2 id="Reactive-Streams"><a href="#Reactive-Streams" class="headerlink" title="Reactive Streams"></a>Reactive Streams</h2><h3 id="Flux-amp-Mono"><a href="#Flux-amp-Mono" class="headerlink" title="Flux &amp; Mono"></a>Flux &amp; Mono</h3><p>在 RSocket 中，使用 Flux 和 Mono 两个 Reactive Streams 框架来处理流数据，其中 Flux 处理一个流中 0 个或多个消息的场景，而 Mono 处理 0 个或最多 1 个消息的场景。</p>
<blockquote>
<p>Flux: A Reactive Streams Publisher with rx operators that emits 0 to N elements, and then completes (successfully or with an error).</p>
</blockquote>
<p><img src="/images/rpc/flux.svg" alt="flux" title="flux"></p>
<blockquote>
<p>Mono: A Reactive Streams Publisher with basic rx operators that emits at most one item via the onNext signal then terminates with an onComplete signal (successful Mono, with or without value), or only emits a single onError signal (failed Mono).</p>
</blockquote>
<p><img src="/images/rpc/mono.svg" alt="mono" title="mono"></p>
<p>Flux 和 Mono 都继承自 Publisher 接口，Publisher 接口只有一个方法 subscribe() 方法，这个方法主要是用来订阅 Subscriber 对象，而 Subscriber 对象用来消息处理数据。</p>
<p><img src="/images/rpc/rsocket-publisher-class.jpg" alt="rsocket-publisher-class" title="rsocket-publisher-class"></p>
<p>Publisher 使用了观察者模式，消费者订阅观察者对象 Subscriber，生产者通过 Publisher 对象发布数据，再通知给 Subscriber 对象。</p>
<p><img src="/images/rpc/rsocket-publisher.jpg" alt="rsocket-publiser" title="rsocket-publisher"></p>
<p>Subscriber 接口是消息最终处理接口，其定义如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Subscriber</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Invoked after calling &#123;<span class="doctag">@link</span> Publisher#subscribe(Subscriber)&#125;.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> s Subscription</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription s)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通知或接收数据</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t the element signaled</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Failed terminal state.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t the throwable signaled</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Successful terminal state.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Subscriber 接口的定义和功能与 gRPC 中 StreamObserver 是类似的。</p>
<h3 id="Frame-格式"><a href="#Frame-格式" class="headerlink" title="Frame 格式"></a>Frame 格式</h3><p>RSocket 使用二进制帧进行通信，其格式如下所示：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">0</span>                   <span class="number">1</span>                   <span class="number">2</span>                   <span class="number">3</span></span><br><span class="line"> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|<span class="number">0</span>|                         Stream ID                           |</span><br><span class="line">+-----------+-+-+---------------+-------------------------------+</span><br><span class="line">|Frame Type |I|M|     Flags     |</span><br><span class="line">+-------------------------------+-------------------------------+</span><br><span class="line">|              Metadata Length                  |</span><br><span class="line">+---------------------------------------------------------------+</span><br><span class="line">|                       Metadata Payload                       ...</span><br><span class="line">+---------------------------------------------------------------+</span><br><span class="line">|                       Payload of Frame                       ...</span><br><span class="line">+---------------------------------------------------------------+</span><br></pre></td></tr></table></figure></p>
<p><strong>字段描述：</strong></p>
<ul>
<li>Stream ID: (31 bits = max value 2^31-1 = 2,147,483,647), 用 31 位无符号整数表示 StreamId, 0 专门用来描述整个连接；</li>
<li>Frame Type:(6 bits = max value 63) 帧类型，下文会介绍；</li>
<li>Flags: (10 bits), 标志位，具体值取决于帧类型，0 表示不设置。协议要求，所有帧要带两个标志位: (I)gnore: 如果不识别该帧是否忽略 ,(M)etadata: 是否带有 Metadata; </li>
<li>Metadata Length: (24 bits = max value 16,777,215), 24 位无符号整数表示 Metadata 长度, 该部分可选，取决于是否有 Metadata; </li>
<li>Metadata: Metadata 元数据; </li>
<li>Payload: 数据。</li>
</ul>
<p><strong>帧类型：</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>RESERVED</td>
<td>0x00</td>
<td>Reserved</td>
</tr>
<tr>
<td><font color="red">SETUP</font></td>
<td>0x01</td>
<td>Setup: Sent by client to initiate protocol processing.</td>
</tr>
<tr>
<td>LEASE</td>
<td>0x02</td>
<td>Lease: Sent by Responder to grant the ability to send requests.</td>
</tr>
<tr>
<td>KEEPALIVE</td>
<td>0x03</td>
<td>Keepalive: Connection keepalive.</td>
</tr>
<tr>
<td><font color="red">REQUEST_RESPONSE</font></td>
<td>0x04</td>
<td>Request Response: Request single response.</td>
</tr>
<tr>
<td><font color="red">REQUEST_FNF</font></td>
<td>0x05</td>
<td>Fire And Forget: A single one-way message.</td>
</tr>
<tr>
<td><font color="red">REQUEST_STREAM </font></td>
<td>0x06</td>
<td>Request Stream: Request a completable stream.</td>
</tr>
<tr>
<td><font color="red">REQUEST_CHANNEL</font></td>
<td>0x07</td>
<td>Request Channel: Request a completable stream in both directions.</td>
</tr>
<tr>
<td>REQUEST_N</td>
<td>0x08</td>
<td>Request N: Request N more items with Reactive Streams semantics.</td>
</tr>
<tr>
<td>CANCEL</td>
<td>0x09</td>
<td>Cancel Request: Cancel outstanding request.</td>
</tr>
<tr>
<td><font color="red">PAYLOAD</font></td>
<td>0x0A</td>
<td>Payload: Payload on a stream. For example, response to a request, or message on a channel.</td>
</tr>
<tr>
<td>ERROR</td>
<td>0x0B</td>
<td>Error: Error at connection or application level.</td>
</tr>
<tr>
<td>METADATA_PUSH</td>
<td>0x0C</td>
<td>Metadata: Asynchronous Metadata frame</td>
</tr>
<tr>
<td><font color="red">RESUME</font></td>
<td>0x0D</td>
<td>Resume: Replaces SETUP for Resuming Operation (optional)</td>
</tr>
<tr>
<td>RESUME_OK</td>
<td>0x0E</td>
<td>Resume OK : Sent in response to a RESUME if resuming operation possible (optional)</td>
</tr>
<tr>
<td>EXT</td>
<td>0x3F</td>
<td>Extension Header: Used To Extend more frame types as well as extensions.</td>
</tr>
</tbody>
</table>
<p>在建立好连接之后，发送的第一帧是 SETUP 或 RESUME，主要用于协商客户端与服务器相关的信息，其中 RESUME 用于连接的重建。SETUP 帧的格式如下所示：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">0</span>                   <span class="number">1</span>                   <span class="number">2</span>                   <span class="number">3</span></span><br><span class="line"> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                         Stream ID = <span class="number">0</span>                         |</span><br><span class="line">+-----------+-+-+-+-+-----------+-------------------------------+</span><br><span class="line">|Frame Type |<span class="number">0</span>|M|R|L|  Flags    |</span><br><span class="line">+-----------+-+-+-+-+-----------+-------------------------------+</span><br><span class="line">|         Major Version         |        Minor Version          |</span><br><span class="line">+-------------------------------+-------------------------------+</span><br><span class="line">|<span class="number">0</span>|                 Time Between KEEPALIVE Frames               |</span><br><span class="line">+---------------------------------------------------------------+</span><br><span class="line">|<span class="number">0</span>|                       Max Lifetime                          |</span><br><span class="line">+---------------------------------------------------------------+</span><br><span class="line">|         Token Length          | Resume Identification Token  ...</span><br><span class="line">+---------------+-----------------------------------------------+</span><br><span class="line">|  MIME Length  |   Metadata Encoding MIME Type                ...</span><br><span class="line">+---------------+-----------------------------------------------+</span><br><span class="line">|  MIME Length  |     Data Encoding MIME Type                  ...</span><br><span class="line">+---------------+-----------------------------------------------+</span><br><span class="line">                      Metadata &amp; Setup Payload</span><br></pre></td></tr></table></figure>
<p>协商的内容包括协议的版本、KEEPALIVE 间隔时间(单位:ms)、服务保活最大时长(单位:ms)、用于 Resume 的 token(恢复连接时进行比对)、Metadata 编码类型及 Data 编码类型。一旦协商成功，就可以发送后续的请求帧。</p>
<h3 id="通信模型"><a href="#通信模型" class="headerlink" title="通信模型"></a>通信模型</h3><p>在 RSocket 中支持四种通信模型，分别是：</p>
<ul>
<li>Fire-Forget: 只发送 Request，不用 Response;</li>
<li>Request-Response: 一个 Request，一个 Response;</li>
<li>Request-Stream: 一个 Request, 响应为 Stream;</li>
<li>Channel：双向流。</li>
</ul>
<p><img src="/images/rpc/rsocket-interaction-model.png" alt="rsocket-interaction-model" title="rsocket-interaction-model"></p>
<p>四种通信模型对应的帧请求分别为:REQUEST_FNF,REQUEST_RESPONSE,REQUEST_STREAM 及 REQUEST_CHANNEL, 响应结果使用 PAYLOAD 帧，PAYLOAD 用来传输数据。另外，响应结束的 COMPLETE 标志位在 PAYLOAD 帧中定义。 PAYLOAD 定义如下：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">0</span>                   <span class="number">1</span>                   <span class="number">2</span>                   <span class="number">3</span></span><br><span class="line"> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                           Stream ID                           |</span><br><span class="line">+-----------+-+-+-+-+-+---------+-------------------------------+</span><br><span class="line">|Frame Type |<span class="number">0</span>|M|F|C|N|  Flags  |</span><br><span class="line">+-------------------------------+-------------------------------+</span><br><span class="line">                     Metadata &amp; Data</span><br></pre></td></tr></table></figure></p>
<ul>
<li>Frame Type: (6 bits) 0x0A;</li>
<li>Flags: (10 bits):<ul>
<li>(M)etadata: 带有 Metadata 数据；</li>
<li>(F)ollows: 表示是否将数据分包(fragments),请求数据大于一个 Frame 长度时使用；</li>
<li>(C)omplete: 流结束标志位，如果设置，onComplete() 方法会被调用; </li>
<li>(N)ext: 传递数据，如果设置，onNext(Payload) 方法会被调用;</li>
</ul>
</li>
<li>Payload Data: 数据</li>
</ul>
<p>REQUEST_FNF, REQUEST_RESPONSE, REQUEST_STREAM 及 REQUEST_CHANNEL 定义比较类似，也相对简单，以 REQUEST_RESPONSE 为例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">0</span>                   <span class="number">1</span>                   <span class="number">2</span>                   <span class="number">3</span></span><br><span class="line"> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                           Stream ID                           |</span><br><span class="line">+-----------+-+-+-+-------------+-------------------------------+</span><br><span class="line">|Frame Type |<span class="number">0</span>|M|F|     Flags   |</span><br><span class="line">+-------------------------------+</span><br><span class="line">                     Metadata &amp; Request Data</span><br></pre></td></tr></table></figure>
<ul>
<li>Frame Type: (6 bits) 0x04;</li>
<li>Flags: (10 bits):<ul>
<li>(M)etadata: 带有 Metadata 数据；</li>
<li>(F)ollows: 表示是否将数据分包(fragments),请求数据大于一个 Frame 长度时使用；<br>Request Data: 请求的数据</li>
</ul>
</li>
</ul>
<p>说完帧的格式，我们来看下 Requester 和 Responder 之间的通信流程，以 Request-Response 为例，先作以下约定：</p>
<blockquote>
<p>“RQ -&gt; RS” refers to Requester sending a frame to a Responder. And “RS -&gt; RQ” refers to Responder.<br>“*” refers to 0 or more and “+” refers to 1 or more.</p>
</blockquote>
<p><strong>Request-Response:</strong><br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> RQ -&gt; RS: REQUEST_RESPONSE</span><br><span class="line"><span class="number">2.</span> RS -&gt; RQ: PAYLOAD with COMPLETE</span><br><span class="line">or</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> RQ -&gt; RS: REQUEST_RESPONSE</span><br><span class="line"><span class="number">2.</span> RS -&gt; RQ: ERROR[APPLICATION_ERROR|REJECTED|CANCELED|INVALID]</span><br><span class="line">or</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> RQ -&gt; RS: REQUEST_RESPONSE</span><br><span class="line"><span class="number">2.</span> RQ -&gt; RS: CANCEL</span><br></pre></td></tr></table></figure></p>
<p>有三种情况：</p>
<ol>
<li>请求正常，Requester 发送一个 REQUEST_RESPONSE 帧，Responder 响应一个带 COMPLETE 标志位的 PAYLOAD;</li>
<li>请求出错，Requester 发送一个 REQUEST_RESPONSE 帧，Responder 响应一个 ERROR 帧，帧中带有错误码及错误信息；</li>
<li>请求取消，Requester 发送一个 REQUEST_RESPONSE 帧，紧接着发送一个 CANCEL, 取消请求。</li>
</ol>
<p>对于 Stream 的情况，则会发送多个 PAYLOAD 帧。</p>
<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><h3 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.rsocket<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rsocket-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.rsocket<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rsocket-transport-netty<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>实例底层的传输使用的是 TCP, 框架采用的是 Netty.</p>
<h3 id="服务器端"><a href="#服务器端" class="headerlink" title="服务器端"></a>服务器端</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RSocket</span> <span class="keyword">extends</span> <span class="title">Availability</span>, <span class="title">Closeable</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="function">Mono&lt;Void&gt; <span class="title">fireAndForget</span><span class="params">(Payload payload)</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function">Mono&lt;Payload&gt; <span class="title">requestResponse</span><span class="params">(Payload payload)</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function">Flux&lt;Payload&gt; <span class="title">requestStream</span><span class="params">(Payload payload)</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function">Flux&lt;Payload&gt; <span class="title">requestChannel</span><span class="params">(Publisher&lt;Payload&gt; payloads)</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="function">Mono&lt;Void&gt; <span class="title">metadataPush</span><span class="params">(Payload payload)</span></span>;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在服务端需要实现 RSocket 接口，并将其添加到服务器中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Server</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 初始化服务器，并向器添加服务实现 RSocketImpl</span></span><br><span class="line">    <span class="keyword">this</span>.server = RSocketFactory.receive()</span><br><span class="line">            .acceptor((setupPayload, reactiveSocket) -&gt; Mono.just(<span class="keyword">new</span> RSocketImpl()))</span><br><span class="line">            .transport(TcpServerTransport.create(<span class="string">"localhost"</span>, TCP_PORT))</span><br><span class="line">            .start()</span><br><span class="line">            .doOnNext(x -&gt; LOG.info(<span class="string">"Server started"</span>))</span><br><span class="line">            .subscribe();</span><br><span class="line"></span><br><span class="line">    initService();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>服务端的 RSocketImpl 代码逻辑如下所示：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * RSocket implementation</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">RSocketImpl</span> <span class="keyword">extends</span> <span class="title">AbstractRSocket</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle Request/Response messages</span></span><br><span class="line"><span class="comment">     * 将请求数据返回给客户端</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payload Message payload</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> payload response</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Payload&gt; <span class="title">requestResponse</span><span class="params">(Payload payload)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            LOG.info(<span class="string">"payload:&#123;&#125;"</span>, payload);</span><br><span class="line">            <span class="keyword">return</span> Mono.just(payload); <span class="comment">// reflect the payload back to the sender</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception x) &#123;</span><br><span class="line">            <span class="keyword">return</span> Mono.error(x);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle Fire-and-Forget messages</span></span><br><span class="line"><span class="comment">     * 将数据发布到 dataPublisher 中</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payload Message payload</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> nothing</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">fireAndForget</span><span class="params">(Payload payload)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            dataPublisher.publish(payload); <span class="comment">// forward the payload</span></span><br><span class="line">            <span class="keyword">return</span> Mono.empty();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception x) &#123;</span><br><span class="line">            <span class="keyword">return</span> Mono.error(x);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle Request/Stream messages. Each request returns a new stream.</span></span><br><span class="line"><span class="comment">     * 使用 dataPublisher 作为响应，数据来源自 fireAndForget 中的数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payload Payload that can be used to determine which stream to return</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Flux stream containing simulated measurement data</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Flux&lt;Payload&gt; <span class="title">requestStream</span><span class="params">(Payload payload)</span> </span>&#123;</span><br><span class="line">        String streamName = payload.getDataUtf8();</span><br><span class="line">        <span class="keyword">if</span> (DATA_STREAM_NAME.equals(streamName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Flux.from(dataPublisher);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Flux.error(<span class="keyword">new</span> IllegalArgumentException(streamName));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle request for bidirectional channel</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payloads Stream of payloads delivered from the client</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Flux&lt;Payload&gt; <span class="title">requestChannel</span><span class="params">(Publisher&lt;Payload&gt; payloads)</span> </span>&#123;</span><br><span class="line">        Flux.from(payloads)</span><br><span class="line">                .subscribe(gameController::processPayload);</span><br><span class="line">        Flux&lt;Payload&gt; channel = Flux.from(gameController);</span><br><span class="line">        <span class="keyword">return</span> channel;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Simple PUblisher to provide async data to Flux stream</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataPublisher</span> <span class="keyword">implements</span> <span class="title">Publisher</span>&lt;<span class="title">Payload</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Subscriber&lt;? <span class="keyword">super</span> Payload&gt;&gt; subscribers = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> Payload&gt; subscriber)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.subscribers.add(subscriber);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发布数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payload 数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publish</span><span class="params">(Payload payload)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        subscribers.stream().forEach(subscriber -&gt; subscriber.onNext(payload));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据结束</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">complete</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        subscribers.stream().forEach(subscriber -&gt; subscriber.onComplete());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="客户端代码"><a href="#客户端代码" class="headerlink" title="客户端代码"></a>客户端代码</h3><p><strong>Fire-and-Forget</strong><br>客户端定时 50s 发送一次数据到服务器，不用服务器响应。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 客户端 socket</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RSocket socket;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;Float&gt; data;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构建客户端</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FireNForgetClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.socket = RSocketFactory.connect()</span><br><span class="line">            .transport(TcpClientTransport.create(<span class="string">"localhost"</span>, TCP_PORT))</span><br><span class="line">            .start()</span><br><span class="line">            .block();</span><br><span class="line">    <span class="keyword">this</span>.data = Collections.unmodifiableList(generateData());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Send binary velocity (float) every 50ms</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Flux.interval(Duration.ofMillis(<span class="number">50</span>))</span><br><span class="line">            .take(data.size())</span><br><span class="line">            .map(<span class="keyword">this</span>::createFloatPayload)</span><br><span class="line">            .flatMap(socket::fireAndForget)</span><br><span class="line">            .blockLast();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>Request-Response</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送一个字符串到服务器，并同步等待结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string 参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">callBlocking</span><span class="params">(String string)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> socket</span><br><span class="line">            .requestResponse(DefaultPayload.create(string))</span><br><span class="line">            .map(Payload::getDataUtf8)</span><br><span class="line">            .onErrorReturn(ERROR_MSG)</span><br><span class="line">            .block();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>Request-Stream</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回一个 Float 列表，一个响应一个 Float</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Float 数字</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Flux&lt;Float&gt; <span class="title">getDataStream</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> socket</span><br><span class="line">            .requestStream(DefaultPayload.create(DATA_STREAM_NAME))</span><br><span class="line">            .map(Payload::getData)</span><br><span class="line">            .map(buf -&gt; buf.getFloat())</span><br><span class="line">            .onErrorReturn(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>Stream-Stream</strong><br>通过 GameController 类，既实现了数据在发送，也实现了数据的处理。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 客户端 socket</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RSocket socket;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送流及处理流</span></span><br><span class="line"><span class="comment"> * 发送流：fireAtWill 方法，线程定时发送数据</span></span><br><span class="line"><span class="comment"> * 接收流：processPayload 方法，处理响应数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> GameController gameController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构建客户端</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ChannelClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.socket = RSocketFactory.connect()</span><br><span class="line">            .transport(TcpClientTransport.create(<span class="string">"localhost"</span>, TCP_PORT))</span><br><span class="line">            .start()</span><br><span class="line">            .block();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.gameController = <span class="keyword">new</span> GameController(<span class="string">"Client Player"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 双向数据流</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">playGame</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    socket.requestChannel(Flux.from(gameController))</span><br><span class="line">            .doOnNext(gameController::processPayload)</span><br><span class="line">            .blockLast();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>GameController 处理逻辑如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GameController</span> <span class="keyword">implements</span> <span class="title">Publisher</span>&lt;<span class="title">Payload</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(GameController<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String playerName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Long&gt; shots;</span><br><span class="line">    <span class="keyword">private</span> Subscriber&lt;? <span class="keyword">super</span> Payload&gt; subscriber;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> truce = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GameController</span><span class="params">(String playerName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.playerName = playerName;</span><br><span class="line">        <span class="keyword">this</span>.shots = generateShotList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a random list of time intervals, 0-1000ms</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> List of time intervals</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;Long&gt; <span class="title">generateShotList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Flux.range(<span class="number">1</span>, SHOT_COUNT)</span><br><span class="line">                .map(x -&gt; (<span class="keyword">long</span>) Math.ceil(Math.random() * <span class="number">1000</span>))</span><br><span class="line">                .collectList()</span><br><span class="line">                .block();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> Payload&gt; subscriber)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.subscriber = subscriber;</span><br><span class="line">        fireAtWill();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Publish game events asynchronously</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fireAtWill</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (Long shotDelay : shots) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123; Thread.sleep(shotDelay); &#125; <span class="keyword">catch</span> (Exception x) &#123;&#125;</span><br><span class="line">                <span class="keyword">if</span> (truce) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                LOG.info(<span class="string">"&#123;&#125;: bang!"</span>, playerName);</span><br><span class="line">                subscriber.onNext(DefaultPayload.create(<span class="string">"bang!"</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!truce) &#123;</span><br><span class="line">                LOG.info(<span class="string">"&#123;&#125;: I give up!"</span>, playerName);</span><br><span class="line">                subscriber.onNext(DefaultPayload.create(<span class="string">"I give up"</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            subscriber.onComplete();</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Process events from the opponent</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payload Payload received from the rSocket</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processPayload</span><span class="params">(Payload payload)</span> </span>&#123;</span><br><span class="line">        String message = payload.getDataUtf8();</span><br><span class="line">        <span class="keyword">switch</span> (message) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"bang!"</span>:</span><br><span class="line">                String result = Math.random() &lt; <span class="number">0.5</span> ? <span class="string">"Haha missed!"</span> : <span class="string">"Ow!"</span>;</span><br><span class="line">                LOG.info(<span class="string">"&#123;&#125;: &#123;&#125;"</span>, playerName, result);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"I give up"</span>:</span><br><span class="line">                truce = <span class="keyword">true</span>;</span><br><span class="line">                LOG.info(<span class="string">"&#123;&#125;: OK, truce"</span>, playerName);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<font color="red">流的操作主要是通过 Publisher 类来实现的。</font>

<h3 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenSendingAString_thenRevceiveTheSameString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ReqResClient client = <span class="keyword">new</span> ReqResClient();</span><br><span class="line">    String string = <span class="string">"Hello RSocket"</span>;</span><br><span class="line"></span><br><span class="line">    assertEquals(string, client.callBlocking(string));</span><br><span class="line"></span><br><span class="line">    client.dispose();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenSendingFireForget</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    FireNForgetClient fnfClient = <span class="keyword">new</span> FireNForgetClient();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// start sending the data</span></span><br><span class="line">    List&lt;Float&gt; data = fnfClient.getData();</span><br><span class="line">    data.stream().forEach(System.out::println);</span><br><span class="line">    fnfClient.sendData();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">        ex.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1. 通过 FireNForgetClient 向服务器定时发送 Float 数据；</span></span><br><span class="line"><span class="comment"> * 2. 服务器接收数据，向 dataPublisher 发布数据；</span></span><br><span class="line"><span class="comment"> * 3. 通过 ReqStreamClient 向服务器请求流数据，数据来自 dataPublisher；</span></span><br><span class="line"><span class="comment"> * 4. ReqStreamClient 订阅来自服务器的数据并处理；</span></span><br><span class="line"><span class="comment"> * 5. 通过 dataPublisher 实现了将 FireNForgetClient 产生的数据发送给了 ReqStreamClient。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenSendingStream_thenReceiveTheSameStream</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// create the client that pushes data to the server and start sending</span></span><br><span class="line">    FireNForgetClient fnfClient = <span class="keyword">new</span> FireNForgetClient();</span><br><span class="line">    <span class="comment">// create a client to read a stream from the server and subscribe to events</span></span><br><span class="line">    ReqStreamClient streamClient = <span class="keyword">new</span> ReqStreamClient();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get the data that is used by the client</span></span><br><span class="line">    List&lt;Float&gt; data = fnfClient.getData();</span><br><span class="line">    <span class="comment">// create a place to count the results</span></span><br><span class="line">    List&lt;Float&gt; dataReceived = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// assert that the data received is the same as the data sent</span></span><br><span class="line">    Disposable subscription = streamClient.getDataStream()</span><br><span class="line">            .index()</span><br><span class="line">            .subscribe(</span><br><span class="line">                    tuple -&gt; &#123;</span><br><span class="line">                        assertEquals(<span class="string">"Wrong value"</span>, data.get(tuple.getT1().intValue()), tuple.getT2());</span><br><span class="line">                        LOG.info(<span class="string">"index:&#123;&#125;,data:&#123;&#125;"</span>,tuple.getT1(),tuple.getT2());</span><br><span class="line">                        dataReceived.add(tuple.getT2());</span><br><span class="line">                    &#125;,</span><br><span class="line">                    err -&gt; LOG.error(err.getMessage())</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// start sending the data</span></span><br><span class="line">    fnfClient.sendData();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// wait a short time for the data to complete then dispose everything</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception x) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    subscription.dispose();</span><br><span class="line">    fnfClient.dispose();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// verify the item count</span></span><br><span class="line">    assertEquals(<span class="string">"Wrong data count received"</span>, data.size(), dataReceived.size());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenRunningChannelGame_thenLogTheResults</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ChannelClient client = <span class="keyword">new</span> ChannelClient();</span><br><span class="line">    client.playGame();</span><br><span class="line">    client.dispose();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过分析 RSocket 通信协议，我们理解了 RSocket 四种通信模型的基本原理，不过 RSocket 提供的功能不仅限于这些，它还提供了更多高级的功能，如文章开头介绍的那样。RSocket 官网提供了翔实的文档，如果感兴趣的话，可以深入理解下。</p>
<p><strong>参考：</strong></p>
<hr>
<p><a href="https://rsocket.io/" target="_blank" rel="noopener">1. rsocket 官方文档</a><br><a href="https://zhuanlan.zhihu.com/p/100511637" target="_blank" rel="noopener">2. RSocket 基于消息传递的反应式应用层网络协议</a><br><a href="https://www.reactivemanifesto.org/zh-CN" target="_blank" rel="noopener">3. 反应式宣言</a><br><a href="https://www.baeldung.com/rsocket" target="_blank" rel="noopener">4. Introduction to RSocket</a><br><a href="https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Flux.html" target="_blank" rel="noopener">5. Flux API</a><br><a href="https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Mono.html" target="_blank" rel="noopener">6. Mono API</a><br><a href="https://medium.com/@b3rnoulli/reactive-service-to-service-communication-with-rsocket-introduction-5d64e5b6909" target="_blank" rel="noopener">7. Reactive service to service communication with RSocket — Introduction</a><br><a href="https://rsocket.io/about/protocol/" target="_blank" rel="noopener">8. Rsocket protocol</a><br><a href="https://javakk.com/1820.html" target="_blank" rel="noopener">9. 响应式服务通信协议RSocket</a></p>

      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/rscocket/" rel="tag"># rscocket</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/11/21/dubbo-overview/" rel="next" title="RPC：Dubbo">
                <i class="fa fa-chevron-left"></i> RPC：Dubbo
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Noahsark</p>
              <p class="site-description motion-element" itemprop="description">不畏将来，不念过往</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">50</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">21</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">164</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#概述"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reactive-Streams"><span class="nav-number">2.</span> <span class="nav-text">Reactive Streams</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Flux-amp-Mono"><span class="nav-number">2.1.</span> <span class="nav-text">Flux &amp; Mono</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Frame-格式"><span class="nav-number">2.2.</span> <span class="nav-text">Frame 格式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通信模型"><span class="nav-number">2.3.</span> <span class="nav-text">通信模型</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实例"><span class="nav-number">3.</span> <span class="nav-text">实例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#引入依赖"><span class="nav-number">3.1.</span> <span class="nav-text">引入依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务器端"><span class="nav-number">3.2.</span> <span class="nav-text">服务器端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#客户端代码"><span class="nav-number">3.3.</span> <span class="nav-text">客户端代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试代码"><span class="nav-number">3.4.</span> <span class="nav-text">测试代码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Noahsark</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="站点总字数">197k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="站点阅读时长">2:59</span>
  
</div>

<div class="BbeiAn-info">
    <a target="_blank" href="https://beian.miit.gov.cn/" rel="nofollow">粤ICP备 2021097726号-1 </a>
	<a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44030702004132" style="text-decoration:none;padding-left:30px;background:url(https://s1.ax1x.com/2018/09/29/ilmwIH.png) no-repeat left center" rel="nofollow">粤公网安备 44030702004132号</a>
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v6.5.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.5.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.5.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.5.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.5.0"></script>



  



  










  





  

  

  

  

  

  
  

  

  

  

  

  

  

</body>
</html>
